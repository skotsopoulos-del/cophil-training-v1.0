<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="CoPhil Advanced Training Program">
<meta name="dcterms.date" content="2025-10-16">

<title>Session 4: Object Detection from Sentinel Imagery – CoPhil EO AI/ML Training</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../day3/notebooks/Day3_Session2_Flood_Mapping_UNet.html" rel="prev">
<link href="../../images/favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-c9822816d3895e59fda95a6fa7545fef.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-3775014fae9fc394bbda1d6ff89dd45e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-509191933"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-509191933', { 'anonymize_ip': true});
</script>
<style>html{ scroll-behavior: smooth; }</style>


<link rel="stylesheet" href="../../styles/custom.css">
<link rel="stylesheet" href="../../styles/phase2-enhancements.css">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">CoPhil EO AI/ML Training</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../../index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-training-days" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Training Days</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-training-days">    
        <li>
    <a class="dropdown-item" href="../../day1/index.html">
 <span class="dropdown-text">Day 1: EO Data &amp; Fundamentals</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../day2/index.html">
 <span class="dropdown-text">Day 2: Machine Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../day3/index.html">
 <span class="dropdown-text">Day 3: Deep Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../day4/index.html">
 <span class="dropdown-text">Day 4: Advanced Topics</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-resources" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Resources</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-resources">    
        <li>
    <a class="dropdown-item" href="../../resources/setup.html">
 <span class="dropdown-text">Setup Guide</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../resources/philippine-eo.html">
 <span class="dropdown-text">Philippine EO Links</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../resources/cheatsheets.html">
 <span class="dropdown-text">Cheat Sheets</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../resources/faq.html">
 <span class="dropdown-text">FAQ</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../resources/glossary.html">
 <span class="dropdown-text">Glossary</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../resources/downloads.html"> <i class="bi bi-download" role="img">
</i> 
<span class="menu-text">Materials</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../day3/notebooks/Day3_Session2_Flood_Mapping_UNet.html">Notebooks</a></li><li class="breadcrumb-item"><a href="../../day3/notebooks/Day3_Session4_Object_Detection_STUDENT.html">Session 4: Object Detection from Sentinel Imagery</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../../index.html" class="sidebar-logo-link">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../day3/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Day 3: Deep Learning for Earth Observation</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">Sessions</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../day3/sessions/session1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Session 1: Semantic Segmentation with U-Net for Earth Observation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../day3/sessions/session2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Session 2: Hands-on Flood Mapping with U-Net and Sentinel-1 SAR</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../day3/sessions/session3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Session 3: Object Detection Techniques for Earth Observation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../day3/sessions/session4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Session 4: Hands-on Object Detection from Sentinel Imagery</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Notebooks</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../day3/notebooks/Day3_Session2_Flood_Mapping_UNet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Session 2: Hands-on Flood Mapping with U-Net and Sentinel-1 SAR</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../day3/notebooks/Day3_Session4_Object_Detection_STUDENT.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Session 4: Object Detection from Sentinel Imagery</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">On This Page</h2>
   
  <ul>
  <li><a href="#lab-overview" id="toc-lab-overview" class="nav-link active" data-scroll-target="#lab-overview">🎓 Lab Overview</a></li>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link" data-scroll-target="#learning-objectives">Learning Objectives</a></li>
  <li><a href="#lab-structure" id="toc-lab-structure" class="nav-link" data-scroll-target="#lab-structure">Lab Structure</a></li>
  <li><a href="#step-1-environment-setup-5-minutes" id="toc-step-1-environment-setup-5-minutes" class="nav-link" data-scroll-target="#step-1-environment-setup-5-minutes">Step 1: Environment Setup (5 minutes)</a>
  <ul class="collapse">
  <li><a href="#check-gpu-availability" id="toc-check-gpu-availability" class="nav-link" data-scroll-target="#check-gpu-availability">Check GPU Availability</a></li>
  </ul></li>
  <li><a href="#step-2-dataset-generation-exploration-15-minutes" id="toc-step-2-dataset-generation-exploration-15-minutes" class="nav-link" data-scroll-target="#step-2-dataset-generation-exploration-15-minutes">Step 2: Dataset Generation &amp; Exploration (15 minutes)</a>
  <ul class="collapse">
  <li><a href="#philippine-context-metro-manila-urban-monitoring" id="toc-philippine-context-metro-manila-urban-monitoring" class="nav-link" data-scroll-target="#philippine-context-metro-manila-urban-monitoring">Philippine Context: Metro Manila Urban Monitoring</a>
  <ul class="collapse">
  <li><a href="#generate-synthetic-dataset" id="toc-generate-synthetic-dataset" class="nav-link" data-scroll-target="#generate-synthetic-dataset">Generate Synthetic Dataset</a></li>
  <li><a href="#split-dataset" id="toc-split-dataset" class="nav-link" data-scroll-target="#split-dataset">Split Dataset</a></li>
  <li><a href="#visualize-sample-images" id="toc-visualize-sample-images" class="nav-link" data-scroll-target="#visualize-sample-images">Visualize Sample Images</a></li>
  <li><a href="#dataset-statistics" id="toc-dataset-statistics" class="nav-link" data-scroll-target="#dataset-statistics">Dataset Statistics</a></li>
  <li><a href="#visualize-distribution" id="toc-visualize-distribution" class="nav-link" data-scroll-target="#visualize-distribution">Visualize Distribution</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#step-3-data-format-annotation-understanding-15-minutes" id="toc-step-3-data-format-annotation-understanding-15-minutes" class="nav-link" data-scroll-target="#step-3-data-format-annotation-understanding-15-minutes">Step 3: Data Format &amp; Annotation Understanding (15 minutes)</a>
  <ul class="collapse">
  <li><a href="#common-annotation-formats" id="toc-common-annotation-formats" class="nav-link" data-scroll-target="#common-annotation-formats">Common Annotation Formats</a></li>
  </ul></li>
  <li><a href="#step-4-load-pre-trained-models-15-minutes" id="toc-step-4-load-pre-trained-models-15-minutes" class="nav-link" data-scroll-target="#step-4-load-pre-trained-models-15-minutes">Step 4: Load Pre-trained Models (15 minutes)</a>
  <ul class="collapse">
  <li><a href="#available-pre-trained-models" id="toc-available-pre-trained-models" class="nav-link" data-scroll-target="#available-pre-trained-models">Available Pre-trained Models</a>
  <ul class="collapse">
  <li><a href="#test-model-inference" id="toc-test-model-inference" class="nav-link" data-scroll-target="#test-model-inference">Test Model Inference</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#step-5-architecture-comparison-20-minutes" id="toc-step-5-architecture-comparison-20-minutes" class="nav-link" data-scroll-target="#step-5-architecture-comparison-20-minutes">Step 5: Architecture Comparison (20 minutes)</a>
  <ul class="collapse">
  <li><a href="#load-additional-models" id="toc-load-additional-models" class="nav-link" data-scroll-target="#load-additional-models">Load Additional Models</a>
  <ul class="collapse">
  <li><a href="#benchmark-inference-speed" id="toc-benchmark-inference-speed" class="nav-link" data-scroll-target="#benchmark-inference-speed">Benchmark Inference Speed</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#step-6-non-maximum-suppression-nms-20-minutes" id="toc-step-6-non-maximum-suppression-nms-20-minutes" class="nav-link" data-scroll-target="#step-6-non-maximum-suppression-nms-20-minutes">Step 6: Non-Maximum Suppression (NMS) (20 minutes)</a>
  <ul class="collapse">
  <li><a href="#understanding-nms" id="toc-understanding-nms" class="nav-link" data-scroll-target="#understanding-nms">Understanding NMS</a>
  <ul class="collapse">
  <li><a href="#implement-iou-calculation" id="toc-implement-iou-calculation" class="nav-link" data-scroll-target="#implement-iou-calculation">Implement IoU Calculation</a></li>
  <li><a href="#visualize-iou" id="toc-visualize-iou" class="nav-link" data-scroll-target="#visualize-iou">Visualize IoU</a></li>
  <li><a href="#implement-nms-algorithm" id="toc-implement-nms-algorithm" class="nav-link" data-scroll-target="#implement-nms-algorithm">Implement NMS Algorithm</a></li>
  <li><a href="#test-nms-on-model-predictions" id="toc-test-nms-on-model-predictions" class="nav-link" data-scroll-target="#test-nms-on-model-predictions">Test NMS on Model Predictions</a></li>
  <li><a href="#visualize-nms-effect" id="toc-visualize-nms-effect" class="nav-link" data-scroll-target="#visualize-nms-effect">Visualize NMS Effect</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#step-7-evaluation-with-map-25-minutes" id="toc-step-7-evaluation-with-map-25-minutes" class="nav-link" data-scroll-target="#step-7-evaluation-with-map-25-minutes">Step 7: Evaluation with mAP (25 minutes)</a>
  <ul class="collapse">
  <li><a href="#understanding-map" id="toc-understanding-map" class="nav-link" data-scroll-target="#understanding-map">Understanding mAP</a>
  <ul class="collapse">
  <li><a href="#implement-map-calculation" id="toc-implement-map-calculation" class="nav-link" data-scroll-target="#implement-map-calculation">Implement mAP Calculation</a></li>
  <li><a href="#calculate-map-on-test-set" id="toc-calculate-map-on-test-set" class="nav-link" data-scroll-target="#calculate-map-on-test-set">Calculate mAP on Test Set</a></li>
  <li><a href="#visualize-precision-recall-curve" id="toc-visualize-precision-recall-curve" class="nav-link" data-scroll-target="#visualize-precision-recall-curve">Visualize Precision-Recall Curve</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#step-8-advanced-visualization-15-minutes" id="toc-step-8-advanced-visualization-15-minutes" class="nav-link" data-scroll-target="#step-8-advanced-visualization-15-minutes">Step 8: Advanced Visualization (15 minutes)</a>
  <ul class="collapse">
  <li><a href="#confidence-score-distribution" id="toc-confidence-score-distribution" class="nav-link" data-scroll-target="#confidence-score-distribution">Confidence Score Distribution</a></li>
  <li><a href="#error-analysis-visualize-failures" id="toc-error-analysis-visualize-failures" class="nav-link" data-scroll-target="#error-analysis-visualize-failures">Error Analysis: Visualize Failures</a></li>
  </ul></li>
  <li><a href="#step-9-export-deployment-15-minutes" id="toc-step-9-export-deployment-15-minutes" class="nav-link" data-scroll-target="#step-9-export-deployment-15-minutes">Step 9: Export &amp; Deployment (15 minutes)</a>
  <ul class="collapse">
  <li><a href="#save-detection-results" id="toc-save-detection-results" class="nav-link" data-scroll-target="#save-detection-results">Save Detection Results</a>
  <ul class="collapse">
  <li><a href="#export-to-geojson-for-gis-integration" id="toc-export-to-geojson-for-gis-integration" class="nav-link" data-scroll-target="#export-to-geojson-for-gis-integration">Export to GeoJSON (for GIS Integration)</a></li>
  <li><a href="#create-summary-report" id="toc-create-summary-report" class="nav-link" data-scroll-target="#create-summary-report">Create Summary Report</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#step-10-troubleshooting-best-practices-10-minutes" id="toc-step-10-troubleshooting-best-practices-10-minutes" class="nav-link" data-scroll-target="#step-10-troubleshooting-best-practices-10-minutes">Step 10: Troubleshooting &amp; Best Practices (10 minutes)</a>
  <ul class="collapse">
  <li><a href="#common-issues-and-solutions" id="toc-common-issues-and-solutions" class="nav-link" data-scroll-target="#common-issues-and-solutions">Common Issues and Solutions</a></li>
  <li><a href="#best-practices-for-production" id="toc-best-practices-for-production" class="nav-link" data-scroll-target="#best-practices-for-production">Best Practices for Production</a>
  <ul class="collapse">
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation">1. Data Preparation</a></li>
  <li><a href="#model-selection" id="toc-model-selection" class="nav-link" data-scroll-target="#model-selection">2. Model Selection</a></li>
  <li><a href="#hyperparameter-tuning" id="toc-hyperparameter-tuning" class="nav-link" data-scroll-target="#hyperparameter-tuning">3. Hyperparameter Tuning</a></li>
  <li><a href="#evaluation" id="toc-evaluation" class="nav-link" data-scroll-target="#evaluation">4. Evaluation</a></li>
  <li><a href="#deployment" id="toc-deployment" class="nav-link" data-scroll-target="#deployment">5. Deployment</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#lab-complete" id="toc-lab-complete" class="nav-link" data-scroll-target="#lab-complete">🎉 Lab Complete!</a>
  <ul class="collapse">
  <li><a href="#what-youve-accomplished" id="toc-what-youve-accomplished" class="nav-link" data-scroll-target="#what-youve-accomplished">What You’ve Accomplished</a>
  <ul class="collapse">
  <li><a href="#technical-skills" id="toc-technical-skills" class="nav-link" data-scroll-target="#technical-skills">Technical Skills:</a></li>
  <li><a href="#conceptual-understanding" id="toc-conceptual-understanding" class="nav-link" data-scroll-target="#conceptual-understanding">Conceptual Understanding:</a></li>
  <li><a href="#philippine-urban-monitoring-context" id="toc-philippine-urban-monitoring-context" class="nav-link" data-scroll-target="#philippine-urban-monitoring-context">Philippine Urban Monitoring Context:</a></li>
  </ul></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways">Key Takeaways</a>
  <ul class="collapse">
  <li><a href="#transfer-learning-works" id="toc-transfer-learning-works" class="nav-link" data-scroll-target="#transfer-learning-works">1. Transfer Learning Works</a></li>
  <li><a href="#nms-is-essential" id="toc-nms-is-essential" class="nav-link" data-scroll-target="#nms-is-essential">2. NMS is Essential</a></li>
  <li><a href="#map-tells-the-full-story" id="toc-map-tells-the-full-story" class="nav-link" data-scroll-target="#map-tells-the-full-story">3. mAP Tells the Full Story</a></li>
  <li><a href="#threshold-tuning-matters" id="toc-threshold-tuning-matters" class="nav-link" data-scroll-target="#threshold-tuning-matters">4. Threshold Tuning Matters</a></li>
  <li><a href="#speed-vs-accuracy-trade-off" id="toc-speed-vs-accuracy-trade-off" class="nav-link" data-scroll-target="#speed-vs-accuracy-trade-off">5. Speed vs Accuracy Trade-off</a></li>
  <li><a href="#domain-specific-fine-tuning-improves-performance" id="toc-domain-specific-fine-tuning-improves-performance" class="nav-link" data-scroll-target="#domain-specific-fine-tuning-improves-performance">6. Domain-Specific Fine-tuning Improves Performance</a></li>
  </ul></li>
  <li><a href="#next-steps-for-production" id="toc-next-steps-for-production" class="nav-link" data-scroll-target="#next-steps-for-production">Next Steps for Production</a>
  <ul class="collapse">
  <li><a href="#real-data-collection" id="toc-real-data-collection" class="nav-link" data-scroll-target="#real-data-collection">1. Real Data Collection</a></li>
  <li><a href="#annotation" id="toc-annotation" class="nav-link" data-scroll-target="#annotation">2. Annotation</a></li>
  <li><a href="#fine-tuning" id="toc-fine-tuning" class="nav-link" data-scroll-target="#fine-tuning">3. Fine-tuning</a></li>
  <li><a href="#deployment-1" id="toc-deployment-1" class="nav-link" data-scroll-target="#deployment-1">4. Deployment</a></li>
  <li><a href="#monitoring" id="toc-monitoring" class="nav-link" data-scroll-target="#monitoring">5. Monitoring</a></li>
  </ul></li>
  <li><a href="#resources-for-further-learning" id="toc-resources-for-further-learning" class="nav-link" data-scroll-target="#resources-for-further-learning">Resources for Further Learning</a>
  <ul class="collapse">
  <li><a href="#papers" id="toc-papers" class="nav-link" data-scroll-target="#papers">Papers</a></li>
  <li><a href="#tutorials" id="toc-tutorials" class="nav-link" data-scroll-target="#tutorials">Tutorials</a></li>
  <li><a href="#datasets" id="toc-datasets" class="nav-link" data-scroll-target="#datasets">Datasets</a></li>
  <li><a href="#tools" id="toc-tools" class="nav-link" data-scroll-target="#tools">Tools</a></li>
  </ul></li>
  <li><a href="#discussion-questions" id="toc-discussion-questions" class="nav-link" data-scroll-target="#discussion-questions">Discussion Questions</a></li>
  <li><a href="#expected-results-summary" id="toc-expected-results-summary" class="nav-link" data-scroll-target="#expected-results-summary">Expected Results Summary</a></li>
  <li><a href="#lab-completion-checklist" id="toc-lab-completion-checklist" class="nav-link" data-scroll-target="#lab-completion-checklist">Lab Completion Checklist</a></li>
  <li><a href="#congratulations" id="toc-congratulations" class="nav-link" data-scroll-target="#congratulations">Congratulations! 🎊</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../day3/notebooks/Day3_Session2_Flood_Mapping_UNet.html">Notebooks</a></li><li class="breadcrumb-item"><a href="../../day3/notebooks/Day3_Session4_Object_Detection_STUDENT.html">Session 4: Object Detection from Sentinel Imagery</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Session 4: Object Detection from Sentinel Imagery</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
<p class="subtitle lead">Building Detection with Transfer Learning for Urban Monitoring</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Instructor</div>
    <div class="quarto-title-meta-contents">
             <p>CoPhil Advanced Training Program </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Date</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 16, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="lab-overview" class="level2">
<h2 class="anchored" data-anchor-id="lab-overview">🎓 Lab Overview</h2>
<p>This hands-on session demonstrates <strong>object detection for Earth observation</strong> using transfer learning. You’ll fine-tune a pre-trained object detection model to detect buildings and informal settlements in Metro Manila from satellite imagery.</p>
<p><strong>Case Study:</strong> Metro Manila Building Detection<br>
<strong>Duration:</strong> 2.5 hours<br>
<strong>Platform:</strong> Google Colab with GPU<br>
<strong>Dataset:</strong> Synthetic Sentinel-2-like imagery (for rapid learning)</p>
<hr>
</section>
<section id="learning-objectives" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives">Learning Objectives</h2>
<p>By the end of this lab, you will be able to:</p>
<ol type="1">
<li>✅ <strong>Understand</strong> transfer learning for object detection in EO applications</li>
<li>✅ <strong>Load and configure</strong> pre-trained models from TensorFlow Hub</li>
<li>✅ <strong>Prepare</strong> satellite imagery and annotations for object detection</li>
<li>✅ <strong>Implement</strong> Non-Maximum Suppression (NMS) for post-processing</li>
<li>✅ <strong>Evaluate</strong> model performance using mAP (mean Average Precision)</li>
<li>✅ <strong>Compare</strong> different detection architectures (SSD, EfficientDet)</li>
<li>✅ <strong>Visualize</strong> detected bounding boxes and analyze predictions</li>
<li>✅ <strong>Export</strong> models for operational deployment</li>
</ol>
<hr>
</section>
<section id="lab-structure" class="level2">
<h2 class="anchored" data-anchor-id="lab-structure">Lab Structure</h2>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Step</th>
<th>Activity</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>1</strong></td>
<td>Environment Setup &amp; GPU Check</td>
<td>5 min</td>
</tr>
<tr class="even">
<td><strong>2</strong></td>
<td>Dataset Generation &amp; Exploration</td>
<td>15 min</td>
</tr>
<tr class="odd">
<td><strong>3</strong></td>
<td>Data Format &amp; Annotation</td>
<td>15 min</td>
</tr>
<tr class="even">
<td><strong>4</strong></td>
<td>Load Pre-trained Models</td>
<td>15 min</td>
</tr>
<tr class="odd">
<td><strong>5</strong></td>
<td>Architecture Comparison</td>
<td>20 min</td>
</tr>
<tr class="even">
<td><strong>6</strong></td>
<td>Non-Maximum Suppression (NMS)</td>
<td>20 min</td>
</tr>
<tr class="odd">
<td><strong>7</strong></td>
<td>Evaluation with mAP</td>
<td>25 min</td>
</tr>
<tr class="even">
<td><strong>8</strong></td>
<td>Advanced Visualization</td>
<td>15 min</td>
</tr>
<tr class="odd">
<td><strong>9</strong></td>
<td>Export &amp; Deployment</td>
<td>15 min</td>
</tr>
<tr class="even">
<td><strong>10</strong></td>
<td>Troubleshooting &amp; Best Practices</td>
<td>10 min</td>
</tr>
</tbody>
</table>
<p><strong>Total:</strong> ~150 minutes</p>
<hr>
</section>
<section id="step-1-environment-setup-5-minutes" class="level1">
<h1>Step 1: Environment Setup (5 minutes)</h1>
<p>First, let’s install required packages and check GPU availability.</p>
<div id="cell-3" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install required packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>q tensorflow<span class="op">-</span>hub pycocotools tensorflow<span class="op">-</span>addons</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✅ Packages installed!"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-4" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard imports</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.patches <span class="im">as</span> patches</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.patches <span class="im">import</span> Rectangle</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># TensorFlow and related</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow_hub <span class="im">as</span> hub</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow <span class="im">import</span> keras</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Set random seeds for reproducibility</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(<span class="dv">42</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">42</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting style</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'figure.figsize'</span>] <span class="op">=</span> (<span class="dv">14</span>, <span class="dv">8</span>)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ TensorFlow version: </span><span class="sc">{</span>tf<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ NumPy version: </span><span class="sc">{</span>np<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="check-gpu-availability" class="level3">
<h3 class="anchored" data-anchor-id="check-gpu-availability">Check GPU Availability</h3>
<p>Object detection benefits significantly from GPU acceleration.</p>
<div id="cell-6" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for GPU</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>gpus <span class="op">=</span> tf.config.list_physical_devices(<span class="st">'GPU'</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> gpus:</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✓ GPU(s) Available: </span><span class="sc">{</span><span class="bu">len</span>(gpus)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> gpu <span class="kw">in</span> gpus:</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  - </span><span class="sc">{</span>gpu<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Enable memory growth</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> gpu <span class="kw">in</span> gpus:</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>            tf.config.experimental.set_memory_growth(gpu, <span class="va">True</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">✓ GPU memory growth enabled"</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">RuntimeError</span> <span class="im">as</span> e:</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(e)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">⚠️  No GPU found - inference will use CPU (slower)"</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"   Consider using Google Colab with GPU runtime"</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">✓ Environment ready!"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
</section>
<section id="step-2-dataset-generation-exploration-15-minutes" class="level1">
<h1>Step 2: Dataset Generation &amp; Exploration (15 minutes)</h1>
<p>For this lab, we’ll generate <strong>synthetic Sentinel-2-like urban imagery</strong> with building annotations. This allows immediate execution while teaching the complete workflow.</p>
<section id="philippine-context-metro-manila-urban-monitoring" class="level2">
<h2 class="anchored" data-anchor-id="philippine-context-metro-manila-urban-monitoring">Philippine Context: Metro Manila Urban Monitoring</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Why Building Detection Matters in Metro Manila
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Location:</strong> National Capital Region (NCR) - 17 cities, 16.7M population<br>
<strong>Challenge:</strong> Rapid urbanization and informal settlement growth</p>
<p><strong>Applications:</strong> - <strong>Disaster Risk Reduction:</strong> Identify vulnerable settlements in flood zones - <strong>Urban Planning:</strong> Monitor informal settlements and infrastructure - <strong>Population Estimation:</strong> Building counts for demographic analysis<br>
- <strong>Change Detection:</strong> Track urban expansion over time - <strong>Resource Allocation:</strong> Target social services and infrastructure development</p>
<p><strong>Data Source:</strong> Sentinel-2 Multispectral Imagery - 10m resolution (RGB bands) - 5-day revisit frequency - Free and open access</p>
</div>
</div>
<section id="generate-synthetic-dataset" class="level3">
<h3 class="anchored" data-anchor-id="generate-synthetic-dataset">Generate Synthetic Dataset</h3>
<p>We’ll create realistic urban scenes with buildings of varying sizes:</p>
<div id="cell-8" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_urban_imagery(n_samples<span class="op">=</span><span class="dv">100</span>, img_size<span class="op">=</span><span class="dv">320</span>, seed<span class="op">=</span><span class="dv">42</span>):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate synthetic Sentinel-2-like urban imagery with building annotations</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">        n_samples: Number of images to generate</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">        img_size: Image dimensions (default 320x320)</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">        seed: Random seed for reproducibility</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">        images: List of RGB images (normalized to [0, 1])</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">        boxes_list: List of bounding boxes per image [y1, x1, y2, x2] normalized</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">        labels_list: List of class labels per image (all 1 for 'building')</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    np.random.seed(seed)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Generating </span><span class="sc">{</span>n_samples<span class="sc">}</span><span class="ss"> synthetic urban scenes..."</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    images <span class="op">=</span> []</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    boxes_list <span class="op">=</span> []</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    labels_list <span class="op">=</span> []</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_samples):</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create base urban scene (gray/brown tones)</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        base_color <span class="op">=</span> np.random.randint(<span class="dv">60</span>, <span class="dv">100</span>, <span class="dv">3</span>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> np.ones((img_size, img_size, <span class="dv">3</span>), dtype<span class="op">=</span>np.uint8) <span class="op">*</span> base_color</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add texture (simulates roads, vegetation patches)</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        noise <span class="op">=</span> np.random.randint(<span class="op">-</span><span class="dv">15</span>, <span class="dv">15</span>, (img_size, img_size, <span class="dv">3</span>))</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> img <span class="op">+</span> noise</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> np.clip(img, <span class="dv">0</span>, <span class="dv">255</span>).astype(np.uint8)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add random vegetation patches (darker green areas)</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        n_veg_patches <span class="op">=</span> np.random.randint(<span class="dv">1</span>, <span class="dv">4</span>)</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_veg_patches):</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>            veg_x <span class="op">=</span> np.random.randint(<span class="dv">0</span>, img_size<span class="op">-</span><span class="dv">30</span>)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>            veg_y <span class="op">=</span> np.random.randint(<span class="dv">0</span>, img_size<span class="op">-</span><span class="dv">30</span>)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>            veg_size <span class="op">=</span> np.random.randint(<span class="dv">15</span>, <span class="dv">40</span>)</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>            veg_color <span class="op">=</span> np.array([<span class="dv">50</span>, <span class="dv">80</span>, <span class="dv">50</span>])  <span class="co"># Green-ish</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>            img[veg_y:veg_y<span class="op">+</span>veg_size, veg_x:veg_x<span class="op">+</span>veg_size] <span class="op">=</span> veg_color</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add buildings (3-10 per image)</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>        n_buildings <span class="op">=</span> np.random.randint(<span class="dv">3</span>, <span class="dv">11</span>)</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        boxes <span class="op">=</span> []</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> []</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_buildings):</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Random building location</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> np.random.randint(<span class="dv">10</span>, img_size<span class="op">-</span><span class="dv">60</span>)</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> np.random.randint(<span class="dv">10</span>, img_size<span class="op">-</span><span class="dv">60</span>)</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Random building size (small, medium, large)</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>            size_type <span class="op">=</span> np.random.choice([<span class="st">'small'</span>, <span class="st">'medium'</span>, <span class="st">'large'</span>], p<span class="op">=</span>[<span class="fl">0.5</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span>])</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> size_type <span class="op">==</span> <span class="st">'small'</span>:</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>                w <span class="op">=</span> np.random.randint(<span class="dv">12</span>, <span class="dv">25</span>)</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>                h <span class="op">=</span> np.random.randint(<span class="dv">12</span>, <span class="dv">25</span>)</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> size_type <span class="op">==</span> <span class="st">'medium'</span>:</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>                w <span class="op">=</span> np.random.randint(<span class="dv">25</span>, <span class="dv">45</span>)</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>                h <span class="op">=</span> np.random.randint(<span class="dv">25</span>, <span class="dv">45</span>)</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:  <span class="co"># large</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>                w <span class="op">=</span> np.random.randint(<span class="dv">45</span>, <span class="dv">70</span>)</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>                h <span class="op">=</span> np.random.randint(<span class="dv">45</span>, <span class="dv">70</span>)</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check bounds</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> x <span class="op">+</span> w <span class="op">&gt;=</span> img_size <span class="kw">or</span> y <span class="op">+</span> h <span class="op">&gt;=</span> img_size:</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw building (bright rectangle - concrete/metal roofs)</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>            building_color <span class="op">=</span> np.random.randint(<span class="dv">150</span>, <span class="dv">230</span>, <span class="dv">3</span>)</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>            img[y:y<span class="op">+</span>h, x:x<span class="op">+</span>w] <span class="op">=</span> building_color</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add some building detail (darker edges for realism)</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>            edge_width <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>            img[y:y<span class="op">+</span>edge_width, x:x<span class="op">+</span>w] <span class="op">=</span> building_color <span class="op">*</span> <span class="fl">0.7</span>  <span class="co"># Top edge</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>            img[y:y<span class="op">+</span>h, x:x<span class="op">+</span>edge_width] <span class="op">=</span> building_color <span class="op">*</span> <span class="fl">0.7</span>  <span class="co"># Left edge</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Normalized bbox [y1, x1, y2, x2] - COCO format</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>            box <span class="op">=</span> [y<span class="op">/</span>img_size, x<span class="op">/</span>img_size, (y<span class="op">+</span>h)<span class="op">/</span>img_size, (x<span class="op">+</span>w)<span class="op">/</span>img_size]</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>            boxes.append(box)</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>            labels.append(<span class="dv">1</span>)  <span class="co"># Class 1 = building</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normalize image to [0, 1]</span></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>        img_normalized <span class="op">=</span> img.astype(np.float32) <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>        images.append(img_normalized)</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>        boxes_list.append(np.array(boxes, dtype<span class="op">=</span>np.float32))</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>        labels_list.append(np.array(labels, dtype<span class="op">=</span>np.int32))</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (i<span class="op">+</span><span class="dv">1</span>) <span class="op">%</span> <span class="dv">25</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Generated </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>n_samples<span class="sc">}</span><span class="ss"> images"</span>)</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✅ Dataset generated successfully!"</span>)</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Total images: </span><span class="sc">{</span><span class="bu">len</span>(images)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Image shape: </span><span class="sc">{</span>images[<span class="dv">0</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Buildings per image: </span><span class="sc">{</span>np<span class="sc">.</span>mean([<span class="bu">len</span>(b) <span class="cf">for</span> b <span class="kw">in</span> boxes_list])<span class="sc">:.1f}</span><span class="ss"> (avg)"</span>)</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> images, boxes_list, labels_list</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate dataset</span></span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>all_images, all_boxes, all_labels <span class="op">=</span> generate_urban_imagery(</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>    n_samples<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>    img_size<span class="op">=</span><span class="dv">320</span>,</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>    seed<span class="op">=</span><span class="dv">42</span></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="split-dataset" class="level3">
<h3 class="anchored" data-anchor-id="split-dataset">Split Dataset</h3>
<p>Split into train (70%), validation (15%), and test (15%) sets:</p>
<div id="cell-10" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Split dataset: 70/15/15</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>n_train <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.70</span> <span class="op">*</span> <span class="bu">len</span>(all_images))</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>n_val <span class="op">=</span> <span class="bu">int</span>(<span class="fl">0.15</span> <span class="op">*</span> <span class="bu">len</span>(all_images))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>train_images <span class="op">=</span> all_images[:n_train]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>train_boxes <span class="op">=</span> all_boxes[:n_train]</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>train_labels <span class="op">=</span> all_labels[:n_train]</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>val_images <span class="op">=</span> all_images[n_train:n_train<span class="op">+</span>n_val]</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>val_boxes <span class="op">=</span> all_boxes[n_train:n_train<span class="op">+</span>n_val]</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>val_labels <span class="op">=</span> all_labels[n_train:n_train<span class="op">+</span>n_val]</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>test_images <span class="op">=</span> all_images[n_train<span class="op">+</span>n_val:]</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>test_boxes <span class="op">=</span> all_boxes[n_train<span class="op">+</span>n_val:]</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>test_labels <span class="op">=</span> all_labels[n_train<span class="op">+</span>n_val:]</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Dataset Split:"</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Train: </span><span class="sc">{</span><span class="bu">len</span>(train_images)<span class="sc">}</span><span class="ss"> images, </span><span class="sc">{</span><span class="bu">sum</span>(<span class="bu">len</span>(b) <span class="cf">for</span> b <span class="kw">in</span> train_boxes)<span class="sc">}</span><span class="ss"> buildings"</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Val:   </span><span class="sc">{</span><span class="bu">len</span>(val_images)<span class="sc">}</span><span class="ss"> images, </span><span class="sc">{</span><span class="bu">sum</span>(<span class="bu">len</span>(b) <span class="cf">for</span> b <span class="kw">in</span> val_boxes)<span class="sc">}</span><span class="ss"> buildings"</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Test:  </span><span class="sc">{</span><span class="bu">len</span>(test_images)<span class="sc">}</span><span class="ss"> images, </span><span class="sc">{</span><span class="bu">sum</span>(<span class="bu">len</span>(b) <span class="cf">for</span> b <span class="kw">in</span> test_boxes)<span class="sc">}</span><span class="ss"> buildings"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="visualize-sample-images" class="level3">
<h3 class="anchored" data-anchor-id="visualize-sample-images">Visualize Sample Images</h3>
<p>Let’s examine the synthetic urban scenes with building annotations:</p>
<div id="cell-12" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_annotated_images(images, boxes_list, labels_list, n_samples<span class="op">=</span><span class="dv">6</span>, title<span class="op">=</span><span class="st">"Annotated Images"</span>):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Visualize images with bounding box annotations</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">11</span>))</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    axes <span class="op">=</span> axes.ravel()</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">min</span>(n_samples, <span class="bu">len</span>(images))):</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> axes[i]</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Display image</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        ax.imshow(images[i])</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw bounding boxes</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        img_h, img_w <span class="op">=</span> <span class="dv">320</span>, <span class="dv">320</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> box, label <span class="kw">in</span> <span class="bu">zip</span>(boxes_list[i], labels_list[i]):</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>            y1, x1, y2, x2 <span class="op">=</span> box</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert normalized coords to pixel coords</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>            x1_px, y1_px <span class="op">=</span> x1 <span class="op">*</span> img_w, y1 <span class="op">*</span> img_h</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>            x2_px, y2_px <span class="op">=</span> x2 <span class="op">*</span> img_w, y2 <span class="op">*</span> img_h</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>            width_px <span class="op">=</span> x2_px <span class="op">-</span> x1_px</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>            height_px <span class="op">=</span> y2_px <span class="op">-</span> y1_px</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw rectangle</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>            rect <span class="op">=</span> Rectangle((x1_px, y1_px), width_px, height_px,</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>                           linewidth<span class="op">=</span><span class="dv">2</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>, facecolor<span class="op">=</span><span class="st">'none'</span>)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>            ax.add_patch(rect)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add label</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>            ax.text(x1_px, y1_px<span class="op">-</span><span class="dv">3</span>, <span class="ss">f'Building'</span>, </span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>                   bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round,pad=0.3'</span>, facecolor<span class="op">=</span><span class="st">'red'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>                   fontsize<span class="op">=</span><span class="dv">8</span>, color<span class="op">=</span><span class="st">'white'</span>, weight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f'Image </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(boxes_list[i])<span class="sc">}</span><span class="ss"> buildings'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>        ax.axis(<span class="st">'off'</span>)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    plt.suptitle(title, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, y<span class="op">=</span><span class="fl">0.995</span>)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize training samples</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>visualize_annotated_images(</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    train_images, train_boxes, train_labels, </span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    n_samples<span class="op">=</span><span class="dv">6</span>, </span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Training Set Samples (with Ground Truth Annotations)"</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="dataset-statistics" class="level3">
<h3 class="anchored" data-anchor-id="dataset-statistics">Dataset Statistics</h3>
<div id="cell-14" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate statistics</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_dataset_stats(boxes_list):</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate bounding box statistics"""</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    all_widths <span class="op">=</span> []</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    all_heights <span class="op">=</span> []</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    all_areas <span class="op">=</span> []</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> boxes <span class="kw">in</span> boxes_list:</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> box <span class="kw">in</span> boxes:</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>            y1, x1, y2, x2 <span class="op">=</span> box</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>            width <span class="op">=</span> x2 <span class="op">-</span> x1</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>            height <span class="op">=</span> y2 <span class="op">-</span> y1</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>            area <span class="op">=</span> width <span class="op">*</span> height</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>            all_widths.append(width)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>            all_heights.append(height)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>            all_areas.append(area)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> all_widths, all_heights, all_areas</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>train_widths, train_heights, train_areas <span class="op">=</span> calculate_dataset_stats(train_boxes)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Training Set Statistics:"</span>)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Total buildings: </span><span class="sc">{</span><span class="bu">len</span>(train_widths)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Buildings per image: </span><span class="sc">{</span><span class="bu">len</span>(train_widths)<span class="op">/</span><span class="bu">len</span>(train_images)<span class="sc">:.1f}</span><span class="ss"> (avg)"</span>)</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  Bounding Box Width (normalized):"</span>)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Mean: </span><span class="sc">{</span>np<span class="sc">.</span>mean(train_widths)<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Std:  </span><span class="sc">{</span>np<span class="sc">.</span>std(train_widths)<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Range: [</span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">min</span>(train_widths)<span class="sc">:.3f}</span><span class="ss">, </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">max</span>(train_widths)<span class="sc">:.3f}</span><span class="ss">]"</span>)</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  Bounding Box Height (normalized):"</span>)</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Mean: </span><span class="sc">{</span>np<span class="sc">.</span>mean(train_heights)<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Std:  </span><span class="sc">{</span>np<span class="sc">.</span>std(train_heights)<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Range: [</span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">min</span>(train_heights)<span class="sc">:.3f}</span><span class="ss">, </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">max</span>(train_heights)<span class="sc">:.3f}</span><span class="ss">]"</span>)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  Bounding Box Area (normalized):"</span>)</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Mean: </span><span class="sc">{</span>np<span class="sc">.</span>mean(train_areas)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Std:  </span><span class="sc">{</span>np<span class="sc">.</span>std(train_areas)<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="visualize-distribution" class="level3">
<h3 class="anchored" data-anchor-id="visualize-distribution">Visualize Distribution</h3>
<div id="cell-16" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot distributions</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">4</span>))</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Width distribution</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].hist(train_widths, bins<span class="op">=</span><span class="dv">30</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'steelblue'</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(np.mean(train_widths), color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f'Mean: </span><span class="sc">{</span>np<span class="sc">.</span>mean(train_widths)<span class="sc">:.3f}</span><span class="ss">'</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Box Width (normalized)'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Count'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Bounding Box Width Distribution'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Height distribution</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].hist(train_heights, bins<span class="op">=</span><span class="dv">30</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'steelblue'</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axvline(np.mean(train_heights), color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f'Mean: </span><span class="sc">{</span>np<span class="sc">.</span>mean(train_heights)<span class="sc">:.3f}</span><span class="ss">'</span>)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Box Height (normalized)'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Count'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Bounding Box Height Distribution'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend()</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Area distribution</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].hist(train_areas, bins<span class="op">=</span><span class="dv">30</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'steelblue'</span>)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].axvline(np.mean(train_areas), color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f'Mean: </span><span class="sc">{</span>np<span class="sc">.</span>mean(train_areas)<span class="sc">:.4f}</span><span class="ss">'</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_xlabel(<span class="st">'Box Area (normalized)'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_ylabel(<span class="st">'Count'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].set_title(<span class="st">'Bounding Box Area Distribution'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].legend()</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">2</span>].grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">✓ Dataset statistics look good!"</span>)</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Wide range of building sizes (small to large)"</span>)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Realistic distribution for urban scenes"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
</section>
</section>
<section id="step-3-data-format-annotation-understanding-15-minutes" class="level1">
<h1>Step 3: Data Format &amp; Annotation Understanding (15 minutes)</h1>
<p>Understanding data formats is critical for object detection. Let’s explore COCO format and conversions.</p>
<section id="common-annotation-formats" class="level2">
<h2 class="anchored" data-anchor-id="common-annotation-formats">Common Annotation Formats</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 36%">
<col style="width: 28%">
<col style="width: 19%">
</colgroup>
<thead>
<tr class="header">
<th>Format</th>
<th>Box Representation</th>
<th>Normalization</th>
<th>Used By</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>COCO</strong></td>
<td>[x, y, width, height]</td>
<td>Pixel coords</td>
<td>TensorFlow Object Detection API</td>
</tr>
<tr class="even">
<td><strong>Pascal VOC</strong></td>
<td>[xmin, ymin, xmax, ymax]</td>
<td>Pixel coords</td>
<td>PyTorch, many tools</td>
</tr>
<tr class="odd">
<td><strong>YOLO</strong></td>
<td>[x_center, y_center, width, height]</td>
<td>Normalized [0,1]</td>
<td>YOLO models</td>
</tr>
<tr class="even">
<td><strong>TF Hub</strong></td>
<td>[y1, x1, y2, x2]</td>
<td>Normalized [0,1]</td>
<td>TensorFlow Hub models</td>
</tr>
</tbody>
</table>
<p>Our data uses <strong>TF Hub format</strong>: <code>[y1, x1, y2, x2]</code> normalized to [0, 1]</p>
<div id="cell-18" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Format conversion functions</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tfhub_to_coco(box, img_h, img_w):</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Convert TF Hub format to COCO format"""</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    y1, x1, y2, x2 <span class="op">=</span> box</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> x1 <span class="op">*</span> img_w</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> y1 <span class="op">*</span> img_h</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> (x2 <span class="op">-</span> x1) <span class="op">*</span> img_w</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    height <span class="op">=</span> (y2 <span class="op">-</span> y1) <span class="op">*</span> img_h</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [x, y, width, height]</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tfhub_to_pascal_voc(box, img_h, img_w):</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Convert TF Hub format to Pascal VOC format"""</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    y1, x1, y2, x2 <span class="op">=</span> box</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    xmin <span class="op">=</span> x1 <span class="op">*</span> img_w</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    ymin <span class="op">=</span> y1 <span class="op">*</span> img_h</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    xmax <span class="op">=</span> x2 <span class="op">*</span> img_w</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    ymax <span class="op">=</span> y2 <span class="op">*</span> img_h</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [xmin, ymin, xmax, ymax]</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tfhub_to_yolo(box, img_h, img_w):</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Convert TF Hub format to YOLO format"""</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    y1, x1, y2, x2 <span class="op">=</span> box</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    x_center <span class="op">=</span> (x1 <span class="op">+</span> x2) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    y_center <span class="op">=</span> (y1 <span class="op">+</span> y2) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> x2 <span class="op">-</span> x1</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    height <span class="op">=</span> y2 <span class="op">-</span> y1</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [x_center, y_center, width, height]</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Test conversions</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>sample_box <span class="op">=</span> train_boxes[<span class="dv">0</span>][<span class="dv">0</span>]  <span class="co"># First box of first image</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>img_h, img_w <span class="op">=</span> <span class="dv">320</span>, <span class="dv">320</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Format Conversion Example:"</span>)</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  TF Hub (normalized):  </span><span class="sc">{</span>sample_box<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  COCO (pixels):        </span><span class="sc">{</span>tfhub_to_coco(sample_box, img_h, img_w)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Pascal VOC (pixels):  </span><span class="sc">{</span>tfhub_to_pascal_voc(sample_box, img_h, img_w)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  YOLO (normalized):    </span><span class="sc">{</span>tfhub_to_yolo(sample_box, img_h, img_w)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
</section>
<section id="step-4-load-pre-trained-models-15-minutes" class="level1">
<h1>Step 4: Load Pre-trained Models (15 minutes)</h1>
<p>Transfer learning uses pre-trained models as feature extractors. Let’s load multiple architectures from TensorFlow Hub.</p>
<section id="available-pre-trained-models" class="level2">
<h2 class="anchored" data-anchor-id="available-pre-trained-models">Available Pre-trained Models</h2>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Model</th>
<th>Speed</th>
<th>Accuracy</th>
<th>Best For</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>SSD MobileNet</strong></td>
<td>Fast</td>
<td>Moderate</td>
<td>Real-time, mobile</td>
</tr>
<tr class="even">
<td><strong>EfficientDet D0</strong></td>
<td>Moderate</td>
<td>Good</td>
<td>Balanced</td>
</tr>
<tr class="odd">
<td><strong>Faster R-CNN ResNet</strong></td>
<td>Slow</td>
<td>High</td>
<td>Accuracy-critical</td>
</tr>
</tbody>
</table>
<p>We’ll use <strong>SSD MobileNet V2</strong> for this lab (fast, good for learning).</p>
<div id="cell-20" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Loading pre-trained SSD MobileNet V2 from TensorFlow Hub..."</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"(This may take 1-2 minutes on first run)</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load model from TF Hub</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>model_url <span class="op">=</span> <span class="st">"https://tfhub.dev/tensorflow/ssd_mobilenet_v2/fpnlite_320x320/1"</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>detector <span class="op">=</span> hub.load(model_url)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✅ Pre-trained model loaded successfully!"</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Model Details:"</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Architecture: SSD MobileNet V2 with FPN-Lite"</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Input size: 320x320 pixels"</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Pre-trained on: COCO dataset (80 object classes)"</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Use case: Transfer learning for building detection"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="test-model-inference" class="level3">
<h3 class="anchored" data-anchor-id="test-model-inference">Test Model Inference</h3>
<p>Let’s run the pre-trained model on one of our images to understand the output format:</p>
<div id="cell-22" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_detection(model, image):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Run object detection on a single image</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">        model: Pre-trained TF Hub detector</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">        image: RGB image (H, W, 3) normalized to [0, 1]</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co">        detections: Dictionary with detection outputs</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to tensor and add batch dimension</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    input_tensor <span class="op">=</span> tf.convert_to_tensor(image, dtype<span class="op">=</span>tf.float32)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    input_tensor <span class="op">=</span> input_tensor[tf.newaxis, ...]  <span class="co"># (1, H, W, 3)</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run inference</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    detections <span class="op">=</span> model(input_tensor)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert outputs to numpy</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    num_detections <span class="op">=</span> <span class="bu">int</span>(detections.pop(<span class="st">'num_detections'</span>))</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    detections <span class="op">=</span> {key: value[<span class="dv">0</span>, :num_detections].numpy()</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">for</span> key, value <span class="kw">in</span> detections.items()}</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    detections[<span class="st">'num_detections'</span>] <span class="op">=</span> num_detections</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> detections</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Test on first training image</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>test_img <span class="op">=</span> train_images[<span class="dv">0</span>]</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>detections <span class="op">=</span> run_detection(detector, test_img)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Detection Output Format:"</span>)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Keys: </span><span class="sc">{</span><span class="bu">list</span>(detections.keys())<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  Number of detections: </span><span class="sc">{</span>detections[<span class="st">'num_detections'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Detection boxes shape: </span><span class="sc">{</span>detections[<span class="st">'detection_boxes'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Detection scores shape: </span><span class="sc">{</span>detections[<span class="st">'detection_scores'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Detection classes shape: </span><span class="sc">{</span>detections[<span class="st">'detection_classes'</span>]<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  Sample detection:"</span>)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Box (normalized): </span><span class="sc">{</span>detections[<span class="st">'detection_boxes'</span>][<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Score: </span><span class="sc">{</span>detections[<span class="st">'detection_scores'</span>][<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Class: </span><span class="sc">{</span><span class="bu">int</span>(detections[<span class="st">'detection_classes'</span>][<span class="dv">0</span>])<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Understanding Model Outputs
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>detection_boxes</strong>: Bounding box coordinates [y1, x1, y2, x2] normalized to [0, 1]<br>
<strong>detection_scores</strong>: Confidence scores [0, 1] - higher is better<br>
<strong>detection_classes</strong>: Class IDs from COCO dataset (1-80)<br>
<strong>num_detections</strong>: Total number of detections (before filtering)</p>
<p><strong>Note:</strong> The model outputs many detections (typically 100) with varying confidence. We’ll use <strong>Non-Maximum Suppression (NMS)</strong> to filter overlapping boxes.</p>
</div>
</div>
<hr>
</section>
</section>
</section>
<section id="step-5-architecture-comparison-20-minutes" class="level1">
<h1>Step 5: Architecture Comparison (20 minutes)</h1>
<p>Let’s compare detection architectures to understand speed vs accuracy trade-offs.</p>
<section id="load-additional-models" class="level2">
<h2 class="anchored" data-anchor-id="load-additional-models">Load Additional Models</h2>
<div id="cell-25" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model URLs from TensorFlow Hub</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>models_info <span class="op">=</span> {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SSD MobileNet V2'</span>: {</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'url'</span>: <span class="st">'https://tfhub.dev/tensorflow/ssd_mobilenet_v2/fpnlite_320x320/1'</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'input_size'</span>: <span class="dv">320</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'description'</span>: <span class="st">'Fast single-stage detector, good for real-time'</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'EfficientDet D0'</span>: {</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'url'</span>: <span class="st">'https://tfhub.dev/tensorflow/efficientdet/d0/1'</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">'input_size'</span>: <span class="dv">512</span>,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'description'</span>: <span class="st">'Balanced speed and accuracy, compound scaling'</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Available Detection Models:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, info <span class="kw">in</span> models_info.items():</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"    Input size: </span><span class="sc">{</span>info[<span class="st">'input_size'</span>]<span class="sc">}</span><span class="ss">x</span><span class="sc">{</span>info[<span class="st">'input_size'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"    Description: </span><span class="sc">{</span>info[<span class="st">'description'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">💡 For this lab, we'll use SSD MobileNet V2 (already loaded)"</span>)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"   To use EfficientDet, replace the model_url above and reload"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="benchmark-inference-speed" class="level3">
<h3 class="anchored" data-anchor-id="benchmark-inference-speed">Benchmark Inference Speed</h3>
<div id="cell-27" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> benchmark_model(model, images, n_runs<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Benchmark model inference speed</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Benchmarking inference speed (</span><span class="sc">{</span>n_runs<span class="sc">}</span><span class="ss"> runs)..."</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    times <span class="op">=</span> []</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Warmup</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">=</span> run_detection(model, images[<span class="dv">0</span>])</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Timed runs</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_runs):</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> time.time()</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        _ <span class="op">=</span> run_detection(model, images[i])</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        elapsed <span class="op">=</span> time.time() <span class="op">-</span> start</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        times.append(elapsed)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    mean_time <span class="op">=</span> np.mean(times)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    std_time <span class="op">=</span> np.std(times)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    fps <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> mean_time</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  Inference time: </span><span class="sc">{</span>mean_time<span class="op">*</span><span class="dv">1000</span><span class="sc">:.1f}</span><span class="ss"> ± </span><span class="sc">{</span>std_time<span class="op">*</span><span class="dv">1000</span><span class="sc">:.1f}</span><span class="ss"> ms"</span>)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  FPS: </span><span class="sc">{</span>fps<span class="sc">:.1f}</span><span class="ss">"</span>)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Throughput: </span><span class="sc">{</span>fps<span class="op">*</span><span class="dv">60</span><span class="sc">:.0f}</span><span class="ss"> images/minute"</span>)</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mean_time, fps</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Benchmark SSD MobileNet</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>ssd_time, ssd_fps <span class="op">=</span> benchmark_model(detector, test_images, n_runs<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">✓ Benchmark complete!"</span>)</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> ssd_fps <span class="op">&gt;</span> <span class="dv">20</span>:</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"  Performance: Suitable for near-real-time processing"</span>)</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> ssd_fps <span class="op">&gt;</span> <span class="dv">5</span>:</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"  Performance: Good for batch processing"</span>)</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"  Performance: Suitable for offline analysis"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
</section>
</section>
<section id="step-6-non-maximum-suppression-nms-20-minutes" class="level1">
<h1>Step 6: Non-Maximum Suppression (NMS) (20 minutes)</h1>
<p>Object detectors output many overlapping boxes. <strong>NMS</strong> filters duplicates to keep only the best detection per object.</p>
<section id="understanding-nms" class="level2">
<h2 class="anchored" data-anchor-id="understanding-nms">Understanding NMS</h2>
<p><strong>Problem:</strong> Multiple boxes detect the same building<br>
<strong>Solution:</strong> Keep box with highest confidence, suppress overlapping boxes<br>
<strong>Method:</strong> Calculate IoU between boxes, remove boxes with IoU &gt; threshold</p>
<section id="implement-iou-calculation" class="level3">
<h3 class="anchored" data-anchor-id="implement-iou-calculation">Implement IoU Calculation</h3>
<div id="cell-29" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_iou(box1, box2):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate Intersection over Union (IoU) between two boxes</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">        box1, box2: Boxes in format [y1, x1, y2, x2] (normalized or pixel)</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">        iou: IoU score [0, 1]</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate intersection coordinates</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    y1_int <span class="op">=</span> <span class="bu">max</span>(box1[<span class="dv">0</span>], box2[<span class="dv">0</span>])</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    x1_int <span class="op">=</span> <span class="bu">max</span>(box1[<span class="dv">1</span>], box2[<span class="dv">1</span>])</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    y2_int <span class="op">=</span> <span class="bu">min</span>(box1[<span class="dv">2</span>], box2[<span class="dv">2</span>])</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    x2_int <span class="op">=</span> <span class="bu">min</span>(box1[<span class="dv">3</span>], box2[<span class="dv">3</span>])</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if boxes overlap</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> y2_int <span class="op">&lt;=</span> y1_int <span class="kw">or</span> x2_int <span class="op">&lt;=</span> x1_int:</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate intersection area</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    intersection <span class="op">=</span> (y2_int <span class="op">-</span> y1_int) <span class="op">*</span> (x2_int <span class="op">-</span> x1_int)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate areas of both boxes</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    area1 <span class="op">=</span> (box1[<span class="dv">2</span>] <span class="op">-</span> box1[<span class="dv">0</span>]) <span class="op">*</span> (box1[<span class="dv">3</span>] <span class="op">-</span> box1[<span class="dv">1</span>])</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    area2 <span class="op">=</span> (box2[<span class="dv">2</span>] <span class="op">-</span> box2[<span class="dv">0</span>]) <span class="op">*</span> (box2[<span class="dv">3</span>] <span class="op">-</span> box2[<span class="dv">1</span>])</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate union area</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    union <span class="op">=</span> area1 <span class="op">+</span> area2 <span class="op">-</span> intersection</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate IoU</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    iou <span class="op">=</span> intersection <span class="op">/</span> union <span class="cf">if</span> union <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> iou</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Test IoU calculation</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"IoU Calculation Examples:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Perfect overlap</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>box_a <span class="op">=</span> [<span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.3</span>]</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>box_b <span class="op">=</span> [<span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.3</span>]</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>iou <span class="op">=</span> calculate_iou(box_a, box_b)</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Perfect overlap: IoU = </span><span class="sc">{</span>iou<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Partial overlap</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>box_c <span class="op">=</span> [<span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.4</span>, <span class="fl">0.4</span>]</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>iou <span class="op">=</span> calculate_iou(box_a, box_c)</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Partial overlap: IoU = </span><span class="sc">{</span>iou<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a><span class="co"># No overlap</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>box_d <span class="op">=</span> [<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">0.7</span>]</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>iou <span class="op">=</span> calculate_iou(box_a, box_d)</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  No overlap:      IoU = </span><span class="sc">{</span>iou<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="visualize-iou" class="level3">
<h3 class="anchored" data-anchor-id="visualize-iou">Visualize IoU</h3>
<div id="cell-31" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_iou(box1, box2, img_size<span class="op">=</span><span class="dv">320</span>):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Visualize two boxes and their IoU</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create blank image</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    ax.set_xlim(<span class="dv">0</span>, img_size)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    ax.set_ylim(img_size, <span class="dv">0</span>)  <span class="co"># Inverted Y-axis</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert normalized to pixels</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> to_pixels(box):</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [c <span class="op">*</span> img_size <span class="cf">for</span> c <span class="kw">in</span> box]</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    box1_px <span class="op">=</span> to_pixels(box1)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    box2_px <span class="op">=</span> to_pixels(box2)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Draw boxes</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    rect1 <span class="op">=</span> Rectangle((box1_px[<span class="dv">1</span>], box1_px[<span class="dv">0</span>]), </span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>                      box1_px[<span class="dv">3</span>]<span class="op">-</span>box1_px[<span class="dv">1</span>], box1_px[<span class="dv">2</span>]<span class="op">-</span>box1_px[<span class="dv">0</span>],</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>                      linewidth<span class="op">=</span><span class="dv">3</span>, edgecolor<span class="op">=</span><span class="st">'blue'</span>, facecolor<span class="op">=</span><span class="st">'blue'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    rect2 <span class="op">=</span> Rectangle((box2_px[<span class="dv">1</span>], box2_px[<span class="dv">0</span>]), </span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>                      box2_px[<span class="dv">3</span>]<span class="op">-</span>box2_px[<span class="dv">1</span>], box2_px[<span class="dv">2</span>]<span class="op">-</span>box2_px[<span class="dv">0</span>],</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>                      linewidth<span class="op">=</span><span class="dv">3</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>, facecolor<span class="op">=</span><span class="st">'red'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    ax.add_patch(rect1)</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    ax.add_patch(rect2)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate and display IoU</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    iou <span class="op">=</span> calculate_iou(box1, box2)</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f'IoU = </span><span class="sc">{</span>iou<span class="sc">:.3f}</span><span class="ss">'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'X (pixels)'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Y (pixels)'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    ax.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add legend</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> matplotlib.patches <span class="im">import</span> Patch</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    legend_elements <span class="op">=</span> [Patch(facecolor<span class="op">=</span><span class="st">'blue'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, edgecolor<span class="op">=</span><span class="st">'blue'</span>, label<span class="op">=</span><span class="st">'Box 1'</span>),</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>                      Patch(facecolor<span class="op">=</span><span class="st">'red'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="st">'Box 2'</span>)]</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>    ax.legend(handles<span class="op">=</span>legend_elements, loc<span class="op">=</span><span class="st">'upper right'</span>)</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize different IoU scenarios</span></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Visualizing IoU Scenarios:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a><span class="co"># High overlap (IoU ~ 0.5)</span></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>visualize_iou([<span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>], [<span class="fl">0.3</span>, <span class="fl">0.3</span>, <span class="fl">0.6</span>, <span class="fl">0.6</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="implement-nms-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="implement-nms-algorithm">Implement NMS Algorithm</h3>
<div id="cell-33" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> non_max_suppression(boxes, scores, iou_threshold<span class="op">=</span><span class="fl">0.5</span>, score_threshold<span class="op">=</span><span class="fl">0.3</span>):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Apply Non-Maximum Suppression to remove duplicate detections</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">        boxes: Array of bounding boxes [N, 4] in format [y1, x1, y2, x2]</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">        scores: Array of confidence scores [N]</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">        iou_threshold: IoU threshold for suppression (default 0.5)</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">        score_threshold: Minimum score to keep detection (default 0.3)</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co">        keep_indices: Indices of boxes to keep</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter by score threshold</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    score_mask <span class="op">=</span> scores <span class="op">&gt;=</span> score_threshold</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    boxes <span class="op">=</span> boxes[score_mask]</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> scores[score_mask]</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(boxes) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.array([], dtype<span class="op">=</span>np.int32)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by scores (descending)</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    sorted_indices <span class="op">=</span> np.argsort(scores)[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    keep_indices <span class="op">=</span> []</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="bu">len</span>(sorted_indices) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Take box with highest score</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>        current_idx <span class="op">=</span> sorted_indices[<span class="dv">0</span>]</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>        keep_indices.append(current_idx)</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(sorted_indices) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate IoU with remaining boxes</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>        current_box <span class="op">=</span> boxes[current_idx]</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>        remaining_boxes <span class="op">=</span> boxes[sorted_indices[<span class="dv">1</span>:]]</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>        ious <span class="op">=</span> np.array([calculate_iou(current_box, box) <span class="cf">for</span> box <span class="kw">in</span> remaining_boxes])</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Keep boxes with IoU below threshold</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>        keep_mask <span class="op">=</span> ious <span class="op">&lt;</span> iou_threshold</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>        sorted_indices <span class="op">=</span> sorted_indices[<span class="dv">1</span>:][keep_mask]</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(keep_indices, dtype<span class="op">=</span>np.int32)</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ NMS function implemented"</span>)</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">NMS Parameters:"</span>)</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  iou_threshold: Remove boxes with IoU &gt; 0.5 (default)"</span>)</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  score_threshold: Keep boxes with score &gt; 0.3 (default)"</span>)</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">These can be tuned based on your application needs"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="test-nms-on-model-predictions" class="level3">
<h3 class="anchored" data-anchor-id="test-nms-on-model-predictions">Test NMS on Model Predictions</h3>
<div id="cell-35" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run detection on test image</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>test_img <span class="op">=</span> test_images[<span class="dv">0</span>]</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>detections <span class="op">=</span> run_detection(detector, test_img)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract boxes and scores</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>pred_boxes <span class="op">=</span> detections[<span class="st">'detection_boxes'</span>]</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>pred_scores <span class="op">=</span> detections[<span class="st">'detection_scores'</span>]</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Before NMS: </span><span class="sc">{</span><span class="bu">len</span>(pred_boxes)<span class="sc">}</span><span class="ss"> detections"</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Score range: [</span><span class="sc">{</span>pred_scores<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.3f}</span><span class="ss">, </span><span class="sc">{</span>pred_scores<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.3f}</span><span class="ss">]"</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply NMS</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>keep_indices <span class="op">=</span> non_max_suppression(</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    pred_boxes, </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    pred_scores, </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    iou_threshold<span class="op">=</span><span class="fl">0.5</span>, </span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    score_threshold<span class="op">=</span><span class="fl">0.3</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>filtered_boxes <span class="op">=</span> pred_boxes[keep_indices]</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>filtered_scores <span class="op">=</span> pred_scores[keep_indices]</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">After NMS: </span><span class="sc">{</span><span class="bu">len</span>(filtered_boxes)<span class="sc">}</span><span class="ss"> detections"</span>)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Score range: [</span><span class="sc">{</span>filtered_scores<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.3f}</span><span class="ss">, </span><span class="sc">{</span>filtered_scores<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.3f}</span><span class="ss">]"</span>)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  Reduction: </span><span class="sc">{</span><span class="bu">len</span>(pred_boxes) <span class="op">-</span> <span class="bu">len</span>(filtered_boxes)<span class="sc">}</span><span class="ss"> boxes removed (</span><span class="sc">{</span>(<span class="dv">1</span><span class="op">-</span><span class="bu">len</span>(filtered_boxes)<span class="op">/</span><span class="bu">len</span>(pred_boxes))<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="visualize-nms-effect" class="level3">
<h3 class="anchored" data-anchor-id="visualize-nms-effect">Visualize NMS Effect</h3>
<div id="cell-37" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_nms_comparison(image, boxes_before, scores_before, boxes_after, scores_after, threshold<span class="op">=</span><span class="fl">0.3</span>):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Visualize detections before and after NMS</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">7</span>))</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Before NMS</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    ax1.imshow(image)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    count_before <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> box, score <span class="kw">in</span> <span class="bu">zip</span>(boxes_before, scores_before):</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> score <span class="op">&gt;</span> threshold:</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>            y1, x1, y2, x2 <span class="op">=</span> box</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>            h, w <span class="op">=</span> <span class="dv">320</span>, <span class="dv">320</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>            rect <span class="op">=</span> Rectangle((x1<span class="op">*</span>w, y1<span class="op">*</span>h), (x2<span class="op">-</span>x1)<span class="op">*</span>w, (y2<span class="op">-</span>y1)<span class="op">*</span>h,</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>                           linewidth<span class="op">=</span><span class="dv">2</span>, edgecolor<span class="op">=</span><span class="st">'yellow'</span>, facecolor<span class="op">=</span><span class="st">'none'</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>            ax1.add_patch(rect)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>            count_before <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="ss">f'Before NMS: </span><span class="sc">{</span>count_before<span class="sc">}</span><span class="ss"> detections'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    ax1.axis(<span class="st">'off'</span>)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># After NMS</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    ax2.imshow(image)</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> box, score <span class="kw">in</span> <span class="bu">zip</span>(boxes_after, scores_after):</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>        y1, x1, y2, x2 <span class="op">=</span> box</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        h, w <span class="op">=</span> <span class="dv">320</span>, <span class="dv">320</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>        rect <span class="op">=</span> Rectangle((x1<span class="op">*</span>w, y1<span class="op">*</span>h), (x2<span class="op">-</span>x1)<span class="op">*</span>w, (y2<span class="op">-</span>y1)<span class="op">*</span>h,</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>                       linewidth<span class="op">=</span><span class="dv">2</span>, edgecolor<span class="op">=</span><span class="st">'lime'</span>, facecolor<span class="op">=</span><span class="st">'none'</span>)</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>        ax2.add_patch(rect)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>        ax2.text(x1<span class="op">*</span>w, y1<span class="op">*</span>h<span class="op">-</span><span class="dv">5</span>, <span class="ss">f'</span><span class="sc">{</span>score<span class="sc">:.2f}</span><span class="ss">'</span>, </span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>                bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round,pad=0.3'</span>, facecolor<span class="op">=</span><span class="st">'lime'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'black'</span>, weight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="ss">f'After NMS: </span><span class="sc">{</span><span class="bu">len</span>(boxes_after)<span class="sc">}</span><span class="ss"> detections'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    ax2.axis(<span class="st">'off'</span>)</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    plt.suptitle(<span class="st">'Non-Maximum Suppression Effect'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize NMS effect</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>visualize_nms_comparison(</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    test_img,</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>    pred_boxes, pred_scores,</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>    filtered_boxes, filtered_scores,</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>    threshold<span class="op">=</span><span class="fl">0.3</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">✓ NMS successfully removed overlapping detections!"</span>)</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Yellow boxes (before): Many overlaps"</span>)</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Green boxes (after): Clean, single detection per object"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
</section>
</section>
<section id="step-7-evaluation-with-map-25-minutes" class="level1">
<h1>Step 7: Evaluation with mAP (25 minutes)</h1>
<p><strong>mAP (mean Average Precision)</strong> is the standard metric for object detection. It measures both localization accuracy (IoU) and classification confidence.</p>
<section id="understanding-map" class="level2">
<h2 class="anchored" data-anchor-id="understanding-map">Understanding mAP</h2>
<p><strong>Components:</strong> 1. <strong>IoU Threshold:</strong> Prediction is “correct” if IoU with ground truth &gt; threshold (typically 0.5) 2. <strong>Precision-Recall Curve:</strong> How many detected are correct (precision) vs.&nbsp;how many actual objects found (recall) 3. <strong>Average Precision (AP):</strong> Area under precision-recall curve 4. <strong>mAP:</strong> Mean AP across all classes or IoU thresholds</p>
<p><strong>Common mAP Variants:</strong> - <strong>mAP@0.5:</strong> IoU threshold = 0.5 (PASCAL VOC standard) - <strong>mAP@0.75:</strong> IoU threshold = 0.75 (stricter) - <strong>mAP@[0.5:0.95]:</strong> Average over IoU thresholds from 0.5 to 0.95 (COCO standard)</p>
<section id="implement-map-calculation" class="level3">
<h3 class="anchored" data-anchor-id="implement-map-calculation">Implement mAP Calculation</h3>
<div id="cell-39" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_ap(gt_boxes, pred_boxes, pred_scores, iou_threshold<span class="op">=</span><span class="fl">0.5</span>):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate Average Precision at a specific IoU threshold</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">        gt_boxes: Ground truth boxes [N, 4]</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">        pred_boxes: Predicted boxes [M, 4]</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">        pred_scores: Prediction scores [M]</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">        iou_threshold: IoU threshold for correct detection</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">        ap: Average Precision</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">        precision: Precision values</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">        recall: Recall values</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(pred_boxes) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.0</span>, np.array([]), np.array([])</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort predictions by confidence (descending)</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    sorted_indices <span class="op">=</span> np.argsort(pred_scores)[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    pred_boxes <span class="op">=</span> pred_boxes[sorted_indices]</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    pred_scores <span class="op">=</span> pred_scores[sorted_indices]</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Track which ground truth boxes have been matched</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    gt_matched <span class="op">=</span> np.zeros(<span class="bu">len</span>(gt_boxes), dtype<span class="op">=</span><span class="bu">bool</span>)</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Track true positives and false positives</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    tp <span class="op">=</span> np.zeros(<span class="bu">len</span>(pred_boxes))</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    fp <span class="op">=</span> np.zeros(<span class="bu">len</span>(pred_boxes))</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, pred_box <span class="kw">in</span> <span class="bu">enumerate</span>(pred_boxes):</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find best matching ground truth box</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>        best_iou <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        best_gt_idx <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j, gt_box <span class="kw">in</span> <span class="bu">enumerate</span>(gt_boxes):</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> gt_matched[j]:</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>            iou <span class="op">=</span> calculate_iou(pred_box, gt_box)</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> iou <span class="op">&gt;</span> best_iou:</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>                best_iou <span class="op">=</span> iou</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>                best_gt_idx <span class="op">=</span> j</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if detection is correct</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> best_iou <span class="op">&gt;=</span> iou_threshold <span class="kw">and</span> best_gt_idx <span class="op">&gt;=</span> <span class="dv">0</span>:</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>            tp[i] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>            gt_matched[best_gt_idx] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>            fp[i] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate cumulative TP and FP</span></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>    tp_cumsum <span class="op">=</span> np.cumsum(tp)</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>    fp_cumsum <span class="op">=</span> np.cumsum(fp)</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate precision and recall</span></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>    precision <span class="op">=</span> tp_cumsum <span class="op">/</span> (tp_cumsum <span class="op">+</span> fp_cumsum <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>    recall <span class="op">=</span> tp_cumsum <span class="op">/</span> (<span class="bu">len</span>(gt_boxes) <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate AP (area under precision-recall curve)</span></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use 11-point interpolation (PASCAL VOC style)</span></span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>    ap <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> np.arange(<span class="dv">0</span>, <span class="fl">1.1</span>, <span class="fl">0.1</span>):</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.<span class="bu">sum</span>(recall <span class="op">&gt;=</span> t) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>            p <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>            p <span class="op">=</span> np.<span class="bu">max</span>(precision[recall <span class="op">&gt;=</span> t])</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>        ap <span class="op">+=</span> p <span class="op">/</span> <span class="dv">11</span></span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ap, precision, recall</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ mAP calculation functions implemented"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="calculate-map-on-test-set" class="level3">
<h3 class="anchored" data-anchor-id="calculate-map-on-test-set">Calculate mAP on Test Set</h3>
<div id="cell-41" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_map(model, images, gt_boxes_list, iou_thresholds<span class="op">=</span>[<span class="fl">0.5</span>, <span class="fl">0.75</span>]):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Evaluate mAP on a dataset</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Evaluating mAP on </span><span class="sc">{</span><span class="bu">len</span>(images)<span class="sc">}</span><span class="ss"> images...</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    ap_per_threshold <span class="op">=</span> {}</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> iou_thresh <span class="kw">in</span> iou_thresholds:</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>        aps <span class="op">=</span> []</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, (image, gt_boxes) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(images, gt_boxes_list)):</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Run detection</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>            detections <span class="op">=</span> run_detection(model, image)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>            pred_boxes <span class="op">=</span> detections[<span class="st">'detection_boxes'</span>]</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>            pred_scores <span class="op">=</span> detections[<span class="st">'detection_scores'</span>]</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Apply NMS</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>            keep_indices <span class="op">=</span> non_max_suppression(</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>                pred_boxes, pred_scores, </span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>                iou_threshold<span class="op">=</span><span class="fl">0.5</span>, </span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>                score_threshold<span class="op">=</span><span class="fl">0.3</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>            pred_boxes <span class="op">=</span> pred_boxes[keep_indices]</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>            pred_scores <span class="op">=</span> pred_scores[keep_indices]</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate AP</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>            ap, _, _ <span class="op">=</span> calculate_ap(gt_boxes, pred_boxes, pred_scores, iou_threshold<span class="op">=</span>iou_thresh)</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>            aps.append(ap)</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (i<span class="op">+</span><span class="dv">1</span>) <span class="op">%</span> <span class="dv">5</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  Processed </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(images)<span class="sc">}</span><span class="ss"> images (IoU=</span><span class="sc">{</span>iou_thresh<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>        map_value <span class="op">=</span> np.mean(aps)</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>        ap_per_threshold[iou_thresh] <span class="op">=</span> map_value</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  mAP@</span><span class="sc">{</span>iou_thresh<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>map_value<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ap_per_threshold</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate on test set</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>map_results <span class="op">=</span> evaluate_map(detector, test_images, test_boxes, iou_thresholds<span class="op">=</span>[<span class="fl">0.5</span>, <span class="fl">0.75</span>])</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"TEST SET RESULTS"</span>)</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> thresh, map_val <span class="kw">in</span> map_results.items():</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"mAP@</span><span class="sc">{</span>thresh<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>map_val<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="visualize-precision-recall-curve" class="level3">
<h3 class="anchored" data-anchor-id="visualize-precision-recall-curve">Visualize Precision-Recall Curve</h3>
<div id="cell-43" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate precision-recall for one image</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>sample_img <span class="op">=</span> test_images[<span class="dv">0</span>]</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>sample_gt <span class="op">=</span> test_boxes[<span class="dv">0</span>]</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>detections <span class="op">=</span> run_detection(detector, sample_img)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>pred_boxes <span class="op">=</span> detections[<span class="st">'detection_boxes'</span>]</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>pred_scores <span class="op">=</span> detections[<span class="st">'detection_scores'</span>]</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply NMS</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>keep_indices <span class="op">=</span> non_max_suppression(pred_boxes, pred_scores, iou_threshold<span class="op">=</span><span class="fl">0.5</span>, score_threshold<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>pred_boxes <span class="op">=</span> pred_boxes[keep_indices]</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>pred_scores <span class="op">=</span> pred_scores[keep_indices]</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate AP and get precision-recall values</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>ap_05, precision, recall <span class="op">=</span> calculate_ap(sample_gt, pred_boxes, pred_scores, iou_threshold<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot precision-recall curve</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>plt.plot(recall, precision, <span class="st">'b-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f'AP@0.5 = </span><span class="sc">{</span>ap_05<span class="sc">:.3f}</span><span class="ss">'</span>)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>plt.fill_between(recall, precision, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Recall'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Precision'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Precision-Recall Curve (Sample Image)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>plt.xlim([<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>plt.ylim([<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>plt.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✓ Average Precision: </span><span class="sc">{</span>ap_05<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  This represents the area under the precision-recall curve"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Interpreting mAP Results
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>mAP Values:</strong> - <strong>&gt; 0.80:</strong> Excellent performance - <strong>0.60 - 0.80:</strong> Good performance - <strong>0.40 - 0.60:</strong> Moderate performance - <strong>&lt; 0.40:</strong> Poor performance</p>
<p><strong>For building detection:</strong> - mAP@0.5 &gt; 0.70 is typically acceptable - mAP@0.75 &gt; 0.50 indicates good localization accuracy</p>
<p><strong>Note:</strong> Pre-trained model without fine-tuning may show lower performance. Fine-tuning on real Philippine data would significantly improve results.</p>
</div>
</div>
<hr>
</section>
</section>
</section>
<section id="step-8-advanced-visualization-15-minutes" class="level1">
<h1>Step 8: Advanced Visualization (15 minutes)</h1>
<p>Let’s create comprehensive visualizations to analyze model performance.</p>
<section id="confidence-score-distribution" class="level3">
<h3 class="anchored" data-anchor-id="confidence-score-distribution">Confidence Score Distribution</h3>
<div id="cell-46" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect all prediction scores from test set</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>all_scores <span class="op">=</span> []</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>correct_scores <span class="op">=</span> []</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>incorrect_scores <span class="op">=</span> []</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> image, gt_boxes <span class="kw">in</span> <span class="bu">zip</span>(test_images, test_boxes):</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    detections <span class="op">=</span> run_detection(detector, image)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    pred_boxes <span class="op">=</span> detections[<span class="st">'detection_boxes'</span>]</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    pred_scores <span class="op">=</span> detections[<span class="st">'detection_scores'</span>]</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply NMS</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    keep_indices <span class="op">=</span> non_max_suppression(pred_boxes, pred_scores, iou_threshold<span class="op">=</span><span class="fl">0.5</span>, score_threshold<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    pred_boxes <span class="op">=</span> pred_boxes[keep_indices]</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    pred_scores <span class="op">=</span> pred_scores[keep_indices]</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    all_scores.extend(pred_scores)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check which predictions are correct</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> pred_box, pred_score <span class="kw">in</span> <span class="bu">zip</span>(pred_boxes, pred_scores):</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find best matching GT box</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>        best_iou <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> gt_box <span class="kw">in</span> gt_boxes:</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>            iou <span class="op">=</span> calculate_iou(pred_box, gt_box)</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>            best_iou <span class="op">=</span> <span class="bu">max</span>(best_iou, iou)</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> best_iou <span class="op">&gt;=</span> <span class="fl">0.5</span>:</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>            correct_scores.append(pred_score)</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>            incorrect_scores.append(pred_score)</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot score distributions</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="co"># All scores</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].hist(all_scores, bins<span class="op">=</span><span class="dv">30</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'steelblue'</span>)</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(<span class="fl">0.5</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Common threshold'</span>)</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Confidence Score'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Count'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'All Prediction Scores'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Correct vs incorrect</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].hist(correct_scores, bins<span class="op">=</span><span class="dv">20</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'green'</span>, label<span class="op">=</span><span class="st">'Correct (IoU≥0.5)'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].hist(incorrect_scores, bins<span class="op">=</span><span class="dv">20</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="st">'Incorrect (IoU&lt;0.5)'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axvline(<span class="fl">0.5</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Threshold'</span>)</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Confidence Score'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Count'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Score Distribution by Correctness'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend()</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Score Statistics:"</span>)</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Total predictions: </span><span class="sc">{</span><span class="bu">len</span>(all_scores)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Correct (IoU≥0.5): </span><span class="sc">{</span><span class="bu">len</span>(correct_scores)<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(correct_scores)<span class="op">/</span><span class="bu">len</span>(all_scores)<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Incorrect (IoU&lt;0.5): </span><span class="sc">{</span><span class="bu">len</span>(incorrect_scores)<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(incorrect_scores)<span class="op">/</span><span class="bu">len</span>(all_scores)<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  Mean score (correct): </span><span class="sc">{</span>np<span class="sc">.</span>mean(correct_scores)<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Mean score (incorrect): </span><span class="sc">{</span>np<span class="sc">.</span>mean(incorrect_scores)<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="error-analysis-visualize-failures" class="level3">
<h3 class="anchored" data-anchor-id="error-analysis-visualize-failures">Error Analysis: Visualize Failures</h3>
<div id="cell-48" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_detections_with_analysis(image, gt_boxes, pred_boxes, pred_scores, iou_threshold<span class="op">=</span><span class="fl">0.5</span>):</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Visualize detections with error analysis</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Green = True Positive (correct detection)</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Red = False Positive (incorrect detection)</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Yellow = False Negative (missed ground truth)</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>))</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    plt.imshow(image)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Track which GT boxes are matched</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    gt_matched <span class="op">=</span> np.zeros(<span class="bu">len</span>(gt_boxes), dtype<span class="op">=</span><span class="bu">bool</span>)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process predictions</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    tp_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    fp_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> pred_box, pred_score <span class="kw">in</span> <span class="bu">zip</span>(pred_boxes, pred_scores):</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        y1, x1, y2, x2 <span class="op">=</span> pred_box</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        h, w <span class="op">=</span> <span class="dv">320</span>, <span class="dv">320</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find best matching GT</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>        best_iou <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>        best_gt_idx <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, gt_box <span class="kw">in</span> <span class="bu">enumerate</span>(gt_boxes):</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> gt_matched[i]:</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>                iou <span class="op">=</span> calculate_iou(pred_box, gt_box)</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> iou <span class="op">&gt;</span> best_iou:</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>                    best_iou <span class="op">=</span> iou</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>                    best_gt_idx <span class="op">=</span> i</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Color based on correctness</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> best_iou <span class="op">&gt;=</span> iou_threshold <span class="kw">and</span> best_gt_idx <span class="op">&gt;=</span> <span class="dv">0</span>:</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>            color <span class="op">=</span> <span class="st">'lime'</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>            label <span class="op">=</span> <span class="ss">f'TP: </span><span class="sc">{</span>pred_score<span class="sc">:.2f}</span><span class="ss">'</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>            gt_matched[best_gt_idx] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>            tp_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>            color <span class="op">=</span> <span class="st">'red'</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>            label <span class="op">=</span> <span class="ss">f'FP: </span><span class="sc">{</span>pred_score<span class="sc">:.2f}</span><span class="ss">'</span></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>            fp_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>        rect <span class="op">=</span> Rectangle((x1<span class="op">*</span>w, y1<span class="op">*</span>h), (x2<span class="op">-</span>x1)<span class="op">*</span>w, (y2<span class="op">-</span>y1)<span class="op">*</span>h,</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>                       linewidth<span class="op">=</span><span class="dv">2</span>, edgecolor<span class="op">=</span>color, facecolor<span class="op">=</span><span class="st">'none'</span>)</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>        plt.gca().add_patch(rect)</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>        plt.text(x1<span class="op">*</span>w, y1<span class="op">*</span>h<span class="op">-</span><span class="dv">5</span>, label,</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>                bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round,pad=0.3'</span>, facecolor<span class="op">=</span>color, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">9</span>, color<span class="op">=</span><span class="st">'black'</span>, weight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Draw unmatched GT boxes (False Negatives)</span></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>    fn_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, gt_box <span class="kw">in</span> <span class="bu">enumerate</span>(gt_boxes):</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> gt_matched[i]:</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>            y1, x1, y2, x2 <span class="op">=</span> gt_box</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>            h, w <span class="op">=</span> <span class="dv">320</span>, <span class="dv">320</span></span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>            rect <span class="op">=</span> Rectangle((x1<span class="op">*</span>w, y1<span class="op">*</span>h), (x2<span class="op">-</span>x1)<span class="op">*</span>w, (y2<span class="op">-</span>y1)<span class="op">*</span>h,</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>                           linewidth<span class="op">=</span><span class="dv">3</span>, edgecolor<span class="op">=</span><span class="st">'yellow'</span>, facecolor<span class="op">=</span><span class="st">'none'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>            plt.gca().add_patch(rect)</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>            plt.text(x1<span class="op">*</span>w, y1<span class="op">*</span>h<span class="op">-</span><span class="dv">5</span>, <span class="st">'FN (Missed)'</span>,</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>                    bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round,pad=0.3'</span>, facecolor<span class="op">=</span><span class="st">'yellow'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>                    fontsize<span class="op">=</span><span class="dv">9</span>, color<span class="op">=</span><span class="st">'black'</span>, weight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>            fn_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f'Detection Analysis | TP: </span><span class="sc">{</span>tp_count<span class="sc">}</span><span class="ss"> | FP: </span><span class="sc">{</span>fp_count<span class="sc">}</span><span class="ss"> | FN: </span><span class="sc">{</span>fn_count<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="st">'off'</span>)</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add legend</span></span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> matplotlib.patches <span class="im">import</span> Patch</span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>    legend_elements <span class="op">=</span> [</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>        Patch(facecolor<span class="op">=</span><span class="st">'lime'</span>, label<span class="op">=</span><span class="st">'True Positive (Correct)'</span>),</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>        Patch(facecolor<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="st">'False Positive (Wrong)'</span>),</span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>        Patch(facecolor<span class="op">=</span><span class="st">'yellow'</span>, label<span class="op">=</span><span class="st">'False Negative (Missed)'</span>)</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>    plt.legend(handles<span class="op">=</span>legend_elements, loc<span class="op">=</span><span class="st">'upper right'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tp_count, fp_count, fn_count</span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyze several test images</span></span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Error Analysis on Test Images:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> test_images[i]</span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a>    gt <span class="op">=</span> test_boxes[i]</span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run detection</span></span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a>    detections <span class="op">=</span> run_detection(detector, img)</span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a>    pred_boxes <span class="op">=</span> detections[<span class="st">'detection_boxes'</span>]</span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a>    pred_scores <span class="op">=</span> detections[<span class="st">'detection_scores'</span>]</span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply NMS</span></span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a>    keep_indices <span class="op">=</span> non_max_suppression(pred_boxes, pred_scores, iou_threshold<span class="op">=</span><span class="fl">0.5</span>, score_threshold<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>    pred_boxes <span class="op">=</span> pred_boxes[keep_indices]</span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a>    pred_scores <span class="op">=</span> pred_scores[keep_indices]</span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Image </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a>    tp, fp, fn <span class="op">=</span> visualize_detections_with_analysis(img, gt, pred_boxes, pred_scores, iou_threshold<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a>    precision <span class="op">=</span> tp <span class="op">/</span> (tp <span class="op">+</span> fp) <span class="cf">if</span> (tp <span class="op">+</span> fp) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a>    recall <span class="op">=</span> tp <span class="op">/</span> (tp <span class="op">+</span> fn) <span class="cf">if</span> (tp <span class="op">+</span> fn) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Precision: </span><span class="sc">{</span>precision<span class="sc">:.3f}</span><span class="ss"> | Recall: </span><span class="sc">{</span>recall<span class="sc">:.3f}</span><span class="ch">\n</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
</section>
<section id="step-9-export-deployment-15-minutes" class="level1">
<h1>Step 9: Export &amp; Deployment (15 minutes)</h1>
<p>For operational use, we need to export models for deployment.</p>
<section id="save-detection-results" class="level2">
<h2 class="anchored" data-anchor-id="save-detection-results">Save Detection Results</h2>
<div id="cell-50" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create output directory</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>os.makedirs(<span class="st">'/content/detection_outputs'</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> export_detections_to_json(images, boxes_list, scores_list, output_file):</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Export detections to JSON format (COCO-like)</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> img_id, (image, boxes, scores) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(images, boxes_list, scores_list)):</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>        img_h, img_w <span class="op">=</span> <span class="dv">320</span>, <span class="dv">320</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> box, score <span class="kw">in</span> <span class="bu">zip</span>(boxes, scores):</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>            y1, x1, y2, x2 <span class="op">=</span> box</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert to COCO format [x, y, width, height] in pixels</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>            x_px <span class="op">=</span> x1 <span class="op">*</span> img_w</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>            y_px <span class="op">=</span> y1 <span class="op">*</span> img_h</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>            w_px <span class="op">=</span> (x2 <span class="op">-</span> x1) <span class="op">*</span> img_w</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>            h_px <span class="op">=</span> (y2 <span class="op">-</span> y1) <span class="op">*</span> img_h</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>            results.append({</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">'image_id'</span>: img_id,</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">'category_id'</span>: <span class="dv">1</span>,  <span class="co"># Building class</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">'bbox'</span>: [<span class="bu">float</span>(x_px), <span class="bu">float</span>(y_px), <span class="bu">float</span>(w_px), <span class="bu">float</span>(h_px)],</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>                <span class="st">'score'</span>: <span class="bu">float</span>(score)</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(output_file, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>        json.dump(results, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Exported </span><span class="sc">{</span><span class="bu">len</span>(results)<span class="sc">}</span><span class="ss"> detections to </span><span class="sc">{</span>output_file<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Run detection on test set and export</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>test_pred_boxes_list <span class="op">=</span> []</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>test_pred_scores_list <span class="op">=</span> []</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> image <span class="kw">in</span> test_images:</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    detections <span class="op">=</span> run_detection(detector, image)</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    pred_boxes <span class="op">=</span> detections[<span class="st">'detection_boxes'</span>]</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>    pred_scores <span class="op">=</span> detections[<span class="st">'detection_scores'</span>]</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply NMS</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>    keep_indices <span class="op">=</span> non_max_suppression(pred_boxes, pred_scores, iou_threshold<span class="op">=</span><span class="fl">0.5</span>, score_threshold<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>    pred_boxes <span class="op">=</span> pred_boxes[keep_indices]</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>    pred_scores <span class="op">=</span> pred_scores[keep_indices]</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>    test_pred_boxes_list.append(pred_boxes)</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>    test_pred_scores_list.append(pred_scores)</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Export to JSON</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>export_detections_to_json(</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>    test_images, </span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>    test_pred_boxes_list, </span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>    test_pred_scores_list,</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">'/content/detection_outputs/test_predictions.json'</span></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="export-to-geojson-for-gis-integration" class="level3">
<h3 class="anchored" data-anchor-id="export-to-geojson-for-gis-integration">Export to GeoJSON (for GIS Integration)</h3>
<div id="cell-52" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> export_to_geojson(boxes_list, scores_list, output_file, origin_lon<span class="op">=</span><span class="fl">121.0</span>, origin_lat<span class="op">=</span><span class="fl">14.6</span>, pixel_size<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Export detections to GeoJSON format for GIS integration</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co">        boxes_list: List of detection boxes</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co">        scores_list: List of confidence scores</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co">        output_file: Output GeoJSON file path</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co">        origin_lon: Longitude of image origin (upper-left)</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co">        origin_lat: Latitude of image origin (upper-left)</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co">        pixel_size: Pixel size in meters (default 10m for Sentinel-2)</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Approximate degrees per meter at latitude</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    meters_per_degree_lat <span class="op">=</span> <span class="fl">111320.0</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    meters_per_degree_lon <span class="op">=</span> <span class="fl">111320.0</span> <span class="op">*</span> np.cos(np.radians(origin_lat))</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> []</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> img_id, (boxes, scores) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(boxes_list, scores_list)):</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> box, score <span class="kw">in</span> <span class="bu">zip</span>(boxes, scores):</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>            y1, x1, y2, x2 <span class="op">=</span> box</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert pixel coords to geographic coords</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>            img_h, img_w <span class="op">=</span> <span class="dv">320</span>, <span class="dv">320</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Top-left corner in pixels</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>            x1_px <span class="op">=</span> x1 <span class="op">*</span> img_w</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>            y1_px <span class="op">=</span> y1 <span class="op">*</span> img_h</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>            x2_px <span class="op">=</span> x2 <span class="op">*</span> img_w</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>            y2_px <span class="op">=</span> y2 <span class="op">*</span> img_h</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert to meters</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>            x1_m <span class="op">=</span> x1_px <span class="op">*</span> pixel_size</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>            y1_m <span class="op">=</span> y1_px <span class="op">*</span> pixel_size</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>            x2_m <span class="op">=</span> x2_px <span class="op">*</span> pixel_size</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>            y2_m <span class="op">=</span> y2_px <span class="op">*</span> pixel_size</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert to geographic coordinates</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>            lon1 <span class="op">=</span> origin_lon <span class="op">+</span> (x1_m <span class="op">/</span> meters_per_degree_lon)</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>            lat1 <span class="op">=</span> origin_lat <span class="op">-</span> (y1_m <span class="op">/</span> meters_per_degree_lat)</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>            lon2 <span class="op">=</span> origin_lon <span class="op">+</span> (x2_m <span class="op">/</span> meters_per_degree_lon)</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>            lat2 <span class="op">=</span> origin_lat <span class="op">-</span> (y2_m <span class="op">/</span> meters_per_degree_lat)</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create polygon (bounding box)</span></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>            coordinates <span class="op">=</span> [[</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>                [lon1, lat1],</span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>                [lon2, lat1],</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>                [lon2, lat2],</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>                [lon1, lat2],</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>                [lon1, lat1]</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>            ]]</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>            feature <span class="op">=</span> {</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>                <span class="st">'type'</span>: <span class="st">'Feature'</span>,</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>                <span class="st">'geometry'</span>: {</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'type'</span>: <span class="st">'Polygon'</span>,</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'coordinates'</span>: coordinates</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>                <span class="st">'properties'</span>: {</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'image_id'</span>: img_id,</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'class'</span>: <span class="st">'building'</span>,</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'confidence'</span>: <span class="bu">float</span>(score),</span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'area_m2'</span>: (x2_m <span class="op">-</span> x1_m) <span class="op">*</span> (y2_m <span class="op">-</span> y1_m)</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>            features.append(feature)</span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>    geojson <span class="op">=</span> {</span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>        <span class="st">'type'</span>: <span class="st">'FeatureCollection'</span>,</span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">'crs'</span>: {</span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>            <span class="st">'type'</span>: <span class="st">'name'</span>,</span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>            <span class="st">'properties'</span>: {<span class="st">'name'</span>: <span class="st">'EPSG:4326'</span>}</span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>        <span class="st">'features'</span>: features</span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(output_file, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a>        json.dump(geojson, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Exported </span><span class="sc">{</span><span class="bu">len</span>(features)<span class="sc">}</span><span class="ss"> building polygons to </span><span class="sc">{</span>output_file<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Ready for QGIS/ArcGIS import"</span>)</span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Export to GeoJSON</span></span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>export_to_geojson(</span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>    test_pred_boxes_list,</span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a>    test_pred_scores_list,</span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>    <span class="st">'/content/detection_outputs/buildings.geojson'</span>,</span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>    origin_lon<span class="op">=</span><span class="fl">121.0</span>,  <span class="co"># Metro Manila approximate</span></span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>    origin_lat<span class="op">=</span><span class="fl">14.6</span>,</span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>    pixel_size<span class="op">=</span><span class="dv">10</span>  <span class="co"># Sentinel-2 resolution</span></span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="create-summary-report" class="level3">
<h3 class="anchored" data-anchor-id="create-summary-report">Create Summary Report</h3>
<div id="cell-54" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate summary report</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>report <span class="op">=</span> {</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'model'</span>: <span class="st">'SSD MobileNet V2'</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'dataset'</span>: {</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'train_images'</span>: <span class="bu">len</span>(train_images),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'val_images'</span>: <span class="bu">len</span>(val_images),</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'test_images'</span>: <span class="bu">len</span>(test_images),</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'total_buildings'</span>: <span class="bu">sum</span>(<span class="bu">len</span>(b) <span class="cf">for</span> b <span class="kw">in</span> test_boxes)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'performance'</span>: {</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mAP@0.5'</span>: <span class="bu">float</span>(map_results.get(<span class="fl">0.5</span>, <span class="dv">0</span>)),</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mAP@0.75'</span>: <span class="bu">float</span>(map_results.get(<span class="fl">0.75</span>, <span class="dv">0</span>)),</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'inference_time_ms'</span>: <span class="bu">float</span>(ssd_time <span class="op">*</span> <span class="dv">1000</span>),</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'fps'</span>: <span class="bu">float</span>(ssd_fps)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'detections'</span>: {</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">'total_predicted'</span>: <span class="bu">sum</span>(<span class="bu">len</span>(b) <span class="cf">for</span> b <span class="kw">in</span> test_pred_boxes_list),</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mean_per_image'</span>: <span class="bu">float</span>(np.mean([<span class="bu">len</span>(b) <span class="cf">for</span> b <span class="kw">in</span> test_pred_boxes_list])),</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mean_confidence'</span>: <span class="bu">float</span>(np.mean([s.mean() <span class="cf">for</span> s <span class="kw">in</span> test_pred_scores_list <span class="cf">if</span> <span class="bu">len</span>(s) <span class="op">&gt;</span> <span class="dv">0</span>]))</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'nms_config'</span>: {</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'iou_threshold'</span>: <span class="fl">0.5</span>,</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'score_threshold'</span>: <span class="fl">0.3</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'/content/detection_outputs/summary_report.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    json.dump(report, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">📊 Summary Report"</span>)</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Model: </span><span class="sc">{</span>report[<span class="st">'model'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Dataset:"</span>)</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key, val <span class="kw">in</span> report[<span class="st">'dataset'</span>].items():</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>val<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Performance:"</span>)</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key, val <span class="kw">in</span> report[<span class="st">'performance'</span>].items():</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>val<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Detections:"</span>)</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key, val <span class="kw">in</span> report[<span class="st">'detections'</span>].items():</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>val<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">✓ All outputs saved to /content/detection_outputs/"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
</section>
</section>
<section id="step-10-troubleshooting-best-practices-10-minutes" class="level1">
<h1>Step 10: Troubleshooting &amp; Best Practices (10 minutes)</h1>
<section id="common-issues-and-solutions" class="level2">
<h2 class="anchored" data-anchor-id="common-issues-and-solutions">Common Issues and Solutions</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Issue 1: Low mAP / Poor Detection Performance
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Symptoms:</strong> - mAP &lt; 0.40 - Many false positives or false negatives - Model detects wrong objects</p>
<p><strong>Solutions:</strong></p>
<ol type="1">
<li><p><strong>Fine-tune on domain-specific data:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre-trained model is trained on COCO (general objects)</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Need to fine-tune on Philippine building dataset</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Use TensorFlow Object Detection API for fine-tuning</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p><strong>Adjust NMS thresholds:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Try different IoU thresholds</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>keep_indices <span class="op">=</span> non_max_suppression(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    boxes, scores,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    iou_threshold<span class="op">=</span><span class="fl">0.3</span>,  <span class="co"># Lower = keep more boxes</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    score_threshold<span class="op">=</span><span class="fl">0.5</span>  <span class="co"># Higher = more confident only</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p><strong>Collect more training data:</strong></p>
<ul>
<li>Minimum 500-1000 annotated images</li>
<li>Diverse building sizes and types</li>
<li>Various lighting and seasons</li>
</ul></li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Issue 2: Slow Inference Speed
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Symptoms:</strong> - FPS &lt; 5 - Long processing time for large areas</p>
<p><strong>Solutions:</strong></p>
<ol type="1">
<li><p><strong>Use lighter model:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Switch to MobileNet (current) or SSD Lite</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>model_url <span class="op">=</span> <span class="st">"https://tfhub.dev/tensorflow/ssd_mobilenet_v2/fpnlite_320x320/1"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p><strong>Optimize model:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Export to TFLite for mobile/edge deployment</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>converter <span class="op">=</span> tf.lite.TFLiteConverter.from_saved_model(model_path)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>converter.optimizations <span class="op">=</span> [tf.lite.Optimize.DEFAULT]</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>tflite_model <span class="op">=</span> converter.convert()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p><strong>Batch processing:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Process multiple images at once</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>batch_images <span class="op">=</span> tf.stack([img1, img2, img3, img4])</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>detections <span class="op">=</span> model(batch_images)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p><strong>Use GPU:</strong></p>
<ul>
<li>Ensure GPU is available in Colab (Runtime → Change runtime type)</li>
<li>Check with <code>tf.config.list_physical_devices('GPU')</code></li>
</ul></li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Issue 3: Too Many False Positives
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Symptoms:</strong> - Model detects buildings where there are none - Low precision (&lt;0.5)</p>
<p><strong>Solutions:</strong></p>
<ol type="1">
<li><p><strong>Increase confidence threshold:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>keep_indices <span class="op">=</span> non_max_suppression(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    boxes, scores,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    score_threshold<span class="op">=</span><span class="fl">0.6</span>  <span class="co"># Increase from 0.3</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p><strong>Add negative examples:</strong></p>
<ul>
<li>Include images with no buildings in training</li>
<li>Annotate “hard negatives” (vegetation, rocks that look like buildings)</li>
</ul></li>
<li><p><strong>Use contextual filtering:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove detections outside urban areas</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Use land cover mask to filter unlikely locations</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Issue 4: Missing Small Buildings
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Symptoms:</strong> - Small buildings not detected - Low recall for small objects</p>
<p><strong>Solutions:</strong></p>
<ol type="1">
<li><p><strong>Use higher resolution input:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use 512x512 or 640x640 instead of 320x320</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: Slower inference</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p><strong>Multi-scale detection:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run detection at multiple scales</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>scales <span class="op">=</span> [<span class="fl">0.75</span>, <span class="fl">1.0</span>, <span class="fl">1.25</span>]</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>all_detections <span class="op">=</span> []</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> scale <span class="kw">in</span> scales:</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    resized <span class="op">=</span> tf.image.resize(image, [<span class="bu">int</span>(<span class="dv">320</span><span class="op">*</span>scale), <span class="bu">int</span>(<span class="dv">320</span><span class="op">*</span>scale)])</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    detections <span class="op">=</span> model(resized)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    all_detections.append(detections)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine and apply NMS</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p><strong>Use architecture with FPN:</strong></p>
<ul>
<li>Feature Pyramid Networks handle multi-scale better</li>
<li>EfficientDet has built-in BiFPN</li>
</ul></li>
</ol>
</div>
</div>
</section>
<section id="best-practices-for-production" class="level2">
<h2 class="anchored" data-anchor-id="best-practices-for-production">Best Practices for Production</h2>
<section id="data-preparation" class="level3">
<h3 class="anchored" data-anchor-id="data-preparation">1. Data Preparation</h3>
<p>✅ Use high-quality annotations (double-check bounding boxes)<br>
✅ Balance dataset across building sizes<br>
✅ Include seasonal variations (wet/dry season)<br>
✅ Annotate at least 1000 images for good performance</p>
</section>
<section id="model-selection" class="level3">
<h3 class="anchored" data-anchor-id="model-selection">2. Model Selection</h3>
<p>✅ <strong>Fast inference needed:</strong> SSD MobileNet<br>
✅ <strong>Balanced:</strong> EfficientDet D0-D2<br>
✅ <strong>High accuracy:</strong> Faster R-CNN ResNet</p>
</section>
<section id="hyperparameter-tuning" class="level3">
<h3 class="anchored" data-anchor-id="hyperparameter-tuning">3. Hyperparameter Tuning</h3>
<p>✅ <strong>NMS IoU threshold:</strong> Start 0.5, tune 0.3-0.7<br>
✅ <strong>Score threshold:</strong> Start 0.3, tune 0.2-0.6<br>
✅ <strong>Test on validation set first</strong></p>
</section>
<section id="evaluation" class="level3">
<h3 class="anchored" data-anchor-id="evaluation">4. Evaluation</h3>
<p>✅ Report mAP@0.5 and mAP@0.75<br>
✅ Calculate per-class metrics<br>
✅ Analyze false positives and false negatives<br>
✅ Test on diverse geographic regions</p>
</section>
<section id="deployment" class="level3">
<h3 class="anchored" data-anchor-id="deployment">5. Deployment</h3>
<p>✅ Export to TFLite or ONNX for production<br>
✅ Monitor inference time and memory usage<br>
✅ Implement batch processing for large areas<br>
✅ Add geographic post-processing (filter by land cover)</p>
<hr>
</section>
</section>
</section>
<section id="lab-complete" class="level1">
<h1>🎉 Lab Complete!</h1>
<section id="what-youve-accomplished" class="level2">
<h2 class="anchored" data-anchor-id="what-youve-accomplished">What You’ve Accomplished</h2>
<section id="technical-skills" class="level3">
<h3 class="anchored" data-anchor-id="technical-skills">Technical Skills:</h3>
<p>✅ <strong>Loaded</strong> pre-trained object detection models from TensorFlow Hub<br>
✅ <strong>Generated</strong> synthetic urban satellite imagery with annotations<br>
✅ <strong>Implemented</strong> Non-Maximum Suppression (NMS) from scratch<br>
✅ <strong>Calculated</strong> mAP (mean Average Precision) for model evaluation<br>
✅ <strong>Compared</strong> detection architectures (speed vs accuracy)<br>
✅ <strong>Visualized</strong> detections with comprehensive error analysis<br>
✅ <strong>Exported</strong> results in multiple formats (JSON, GeoJSON)<br>
✅ <strong>Applied</strong> transfer learning for Philippine building detection</p>
</section>
<section id="conceptual-understanding" class="level3">
<h3 class="anchored" data-anchor-id="conceptual-understanding">Conceptual Understanding:</h3>
<p>✅ Transfer learning for object detection<br>
✅ Bounding box formats (COCO, Pascal VOC, YOLO, TF Hub)<br>
✅ NMS algorithm and its importance<br>
✅ mAP metric and precision-recall curves<br>
✅ IoU calculation and thresholds<br>
✅ Model architecture trade-offs (SSD vs Faster R-CNN)<br>
✅ Error types (TP, FP, FN) and their operational implications</p>
</section>
<section id="philippine-urban-monitoring-context" class="level3">
<h3 class="anchored" data-anchor-id="philippine-urban-monitoring-context">Philippine Urban Monitoring Context:</h3>
<p>✅ Building detection for disaster risk reduction<br>
✅ Informal settlement mapping for urban planning<br>
✅ Change detection for infrastructure development<br>
✅ GIS integration for operational use</p>
<hr>
</section>
</section>
<section id="key-takeaways" class="level2">
<h2 class="anchored" data-anchor-id="key-takeaways">Key Takeaways</h2>
<section id="transfer-learning-works" class="level3">
<h3 class="anchored" data-anchor-id="transfer-learning-works">1. Transfer Learning Works</h3>
<p>Pre-trained models (COCO dataset) provide good starting point for building detection, even without fine-tuning.</p>
</section>
<section id="nms-is-essential" class="level3">
<h3 class="anchored" data-anchor-id="nms-is-essential">2. NMS is Essential</h3>
<p>Object detectors output many overlapping boxes. NMS filters duplicates to give clean results.</p>
</section>
<section id="map-tells-the-full-story" class="level3">
<h3 class="anchored" data-anchor-id="map-tells-the-full-story">3. mAP Tells the Full Story</h3>
<p>mAP combines localization accuracy and classification confidence into single metric. Always report mAP@0.5 and mAP@0.75.</p>
</section>
<section id="threshold-tuning-matters" class="level3">
<h3 class="anchored" data-anchor-id="threshold-tuning-matters">4. Threshold Tuning Matters</h3>
<p>NMS IoU threshold and confidence threshold significantly affect results. Tune on validation set.</p>
</section>
<section id="speed-vs-accuracy-trade-off" class="level3">
<h3 class="anchored" data-anchor-id="speed-vs-accuracy-trade-off">5. Speed vs Accuracy Trade-off</h3>
<ul>
<li><strong>Real-time:</strong> SSD MobileNet</li>
<li><strong>Balanced:</strong> EfficientDet</li>
<li><strong>Accuracy-critical:</strong> Faster R-CNN</li>
</ul>
</section>
<section id="domain-specific-fine-tuning-improves-performance" class="level3">
<h3 class="anchored" data-anchor-id="domain-specific-fine-tuning-improves-performance">6. Domain-Specific Fine-tuning Improves Performance</h3>
<p>For production use, fine-tune on Philippine building dataset using TensorFlow Object Detection API.</p>
<hr>
</section>
</section>
<section id="next-steps-for-production" class="level2">
<h2 class="anchored" data-anchor-id="next-steps-for-production">Next Steps for Production</h2>
<section id="real-data-collection" class="level3">
<h3 class="anchored" data-anchor-id="real-data-collection">1. Real Data Collection</h3>
<ul>
<li>Acquire Sentinel-2 imagery for Metro Manila</li>
<li>Download from <a href="https://scihub.copernicus.eu/">Copernicus Open Access Hub</a></li>
<li>Or use Google Earth Engine</li>
</ul>
</section>
<section id="annotation" class="level3">
<h3 class="anchored" data-anchor-id="annotation">2. Annotation</h3>
<ul>
<li>Use <a href="https://roboflow.com/">RoboFlow</a> or <a href="https://cvat.org/">CVAT</a> for bounding box annotation</li>
<li>Annotate 500-1000 images minimum</li>
<li>Include diverse building types and sizes</li>
</ul>
</section>
<section id="fine-tuning" class="level3">
<h3 class="anchored" data-anchor-id="fine-tuning">3. Fine-tuning</h3>
<ul>
<li>Use <a href="https://github.com/tensorflow/models/tree/master/research/object_detection">TensorFlow Object Detection API</a></li>
<li>Fine-tune SSD or EfficientDet on Philippine data</li>
<li>Train for 20K-50K steps</li>
</ul>
</section>
<section id="deployment-1" class="level3">
<h3 class="anchored" data-anchor-id="deployment-1">4. Deployment</h3>
<ul>
<li>Export to TFLite for edge deployment</li>
<li>Create batch processing pipeline</li>
<li>Integrate with GIS workflows</li>
<li>Deploy to PhilSA/DOST operational systems</li>
</ul>
</section>
<section id="monitoring" class="level3">
<h3 class="anchored" data-anchor-id="monitoring">5. Monitoring</h3>
<ul>
<li>Track inference time and accuracy</li>
<li>Collect edge cases for retraining</li>
<li>Update model quarterly with new data</li>
</ul>
<hr>
</section>
</section>
<section id="resources-for-further-learning" class="level2">
<h2 class="anchored" data-anchor-id="resources-for-further-learning">Resources for Further Learning</h2>
<section id="papers" class="level3">
<h3 class="anchored" data-anchor-id="papers">Papers</h3>
<ul>
<li><a href="https://arxiv.org/abs/1512.02325">SSD: Single Shot MultiBox Detector</a></li>
<li><a href="https://arxiv.org/abs/1506.01497">Faster R-CNN</a></li>
<li><a href="https://arxiv.org/abs/1911.09070">EfficientDet</a></li>
</ul>
</section>
<section id="tutorials" class="level3">
<h3 class="anchored" data-anchor-id="tutorials">Tutorials</h3>
<ul>
<li><a href="https://tensorflow-object-detection-api-tutorial.readthedocs.io/">TensorFlow Object Detection API Tutorial</a></li>
<li><a href="https://blog.roboflow.com/object-detection/">RoboFlow Object Detection Guide</a></li>
</ul>
</section>
<section id="datasets" class="level3">
<h3 class="anchored" data-anchor-id="datasets">Datasets</h3>
<ul>
<li><a href="http://xviewdataset.org/">xView Dataset</a> - Satellite object detection</li>
<li><a href="https://captain-whu.github.io/DOTA/">DOTA Dataset</a> - Aerial image object detection</li>
<li><a href="https://spacenet.ai/">SpaceNet</a> - Building footprint detection</li>
</ul>
</section>
<section id="tools" class="level3">
<h3 class="anchored" data-anchor-id="tools">Tools</h3>
<ul>
<li><a href="https://tfhub.dev/">TensorFlow Hub</a> - Pre-trained models</li>
<li><a href="https://roboflow.com/">RoboFlow</a> - Dataset management and annotation</li>
<li><a href="https://wandb.ai/">Weights &amp; Biases</a> - Experiment tracking</li>
</ul>
<hr>
</section>
</section>
<section id="discussion-questions" class="level2">
<h2 class="anchored" data-anchor-id="discussion-questions">Discussion Questions</h2>
<ol type="1">
<li><strong>Application Design:</strong>
<ul>
<li>How would you deploy this building detection system for Metro Manila monitoring?</li>
<li>What infrastructure and data pipelines are needed?</li>
</ul></li>
<li><strong>Model Selection:</strong>
<ul>
<li>When would you choose SSD over Faster R-CNN for Philippine use cases?</li>
<li>How do you balance speed vs accuracy requirements?</li>
</ul></li>
<li><strong>Evaluation:</strong>
<ul>
<li>Is mAP@0.5 &gt; 0.70 sufficient for disaster risk reduction applications?</li>
<li>Should we prioritize precision or recall for informal settlement mapping?</li>
</ul></li>
<li><strong>Data Quality:</strong>
<ul>
<li>How many training images are needed for operational accuracy?</li>
<li>How do you handle seasonal variations in Philippine imagery?</li>
</ul></li>
<li><strong>Operational Challenges:</strong>
<ul>
<li>What happens if the model misses a building in a flood zone (false negative)?</li>
<li>How do you validate predictions in remote areas with no ground truth?</li>
</ul></li>
<li><strong>Integration:</strong>
<ul>
<li>How would you integrate detections with existing NAMRIA/PhilSA databases?</li>
<li>What quality control steps are needed before operational use?</li>
</ul></li>
</ol>
<hr>
</section>
<section id="expected-results-summary" class="level2">
<h2 class="anchored" data-anchor-id="expected-results-summary">Expected Results Summary</h2>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric</th>
<th>Expected Range</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>mAP@0.5</strong></td>
<td>0.40 - 0.70</td>
<td>Moderate (pre-trained, no fine-tuning)</td>
</tr>
<tr class="even">
<td><strong>mAP@0.75</strong></td>
<td>0.25 - 0.50</td>
<td>Good localization given constraints</td>
</tr>
<tr class="odd">
<td><strong>Inference Time</strong></td>
<td>50-150 ms</td>
<td>Fast enough for batch processing</td>
</tr>
<tr class="even">
<td><strong>FPS</strong></td>
<td>5-20</td>
<td>Suitable for operational use</td>
</tr>
<tr class="odd">
<td><strong>Precision</strong></td>
<td>0.50 - 0.80</td>
<td>Few false alarms</td>
</tr>
<tr class="even">
<td><strong>Recall</strong></td>
<td>0.60 - 0.85</td>
<td>Catches most buildings</td>
</tr>
</tbody>
</table>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>With Fine-tuning on Philippine Data
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Expected improvements:</strong> - mAP@0.5: <strong>0.70 - 0.90</strong> (+30-40%) - mAP@0.75: <strong>0.50 - 0.75</strong> (+100%) - Precision: <strong>0.75 - 0.92</strong> - Recall: <strong>0.80 - 0.95</strong></p>
<p>Fine-tuning on domain-specific data typically doubles performance!</p>
</div>
</div>
<hr>
</section>
<section id="lab-completion-checklist" class="level2">
<h2 class="anchored" data-anchor-id="lab-completion-checklist">Lab Completion Checklist</h2>
<p>Before finishing, ensure you’ve completed:</p>
<ul class="task-list">
<li><label><input type="checkbox">Generated synthetic urban imagery dataset</label></li>
<li><label><input type="checkbox">Loaded pre-trained SSD MobileNet V2 model</label></li>
<li><label><input type="checkbox">Implemented and tested IoU calculation</label></li>
<li><label><input type="checkbox">Implemented Non-Maximum Suppression</label></li>
<li><label><input type="checkbox">Calculated mAP@0.5 and mAP@0.75</label></li>
<li><label><input type="checkbox">Visualized precision-recall curves</label></li>
<li><label><input type="checkbox">Analyzed detection errors (TP, FP, FN)</label></li>
<li><label><input type="checkbox">Exported results to JSON and GeoJSON</label></li>
<li><label><input type="checkbox">Generated summary report</label></li>
<li><label><input type="checkbox">Understood troubleshooting strategies</label></li>
</ul>
</section>
<section id="congratulations" class="level2 callout-success">
<h2 class="anchored" data-anchor-id="congratulations">Congratulations! 🎊</h2>
<p>You’ve completed a full object detection pipeline for satellite imagery analysis!</p>
<p><strong>What You Built:</strong> - A working building detection system - Complete evaluation framework (mAP, precision-recall) - Production-ready export workflows - GIS-compatible outputs</p>
<p><strong>Impact:</strong> Your skills can now contribute to urban monitoring, disaster risk reduction, and infrastructure planning for Philippine cities.</p>
<p><strong>Next:</strong> Apply these techniques to Day 4 advanced topics (change detection, time series analysis)</p>
</section>
<hr>
<div class="session-nav">
<p><a href="../../day3/sessions/session3.html" class="btn btn-outline-secondary">← Back to Session 3</a> <a href="../../index.html" class="btn btn-primary">Course Summary →</a></p>
</div>
<hr>
<p><em>This hands-on lab is part of the CoPhil 4-Day Advanced Training on AI/ML for Earth Observation, funded by the European Union under the Global Gateway initiative. Materials developed in collaboration with PhilSA, DOST-ASTI, and the European Space Agency.</em></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<script src="https://utteranc.es/client.js" repo="cophil-training-v1.0" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../day3/notebooks/Day3_Session2_Flood_Mapping_UNet.html" class="pagination-link" aria-label="Session 2: Hands-on Flood Mapping with U-Net and Sentinel-1 SAR">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Session 2: Hands-on Flood Mapping with U-Net and Sentinel-1 SAR</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>CoPhil EO AI/ML Training Programme</p>
</div>   
    <div class="nav-footer-center">
<p>Funded by the European Union - Global Gateway Initiative</p>
</div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:skotsopoulos@neuralio.ai">
      <i class="bi bi-envelope" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://philsa.gov.ph">
      <i class="bi bi-globe" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>